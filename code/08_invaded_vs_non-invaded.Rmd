---
title: "Invaded vs non invaded"
author: "Fernando Cagua"
date: "5 October 2015"
output: html_document
---

```{r, echo = FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(magrittr)
library(knitr)
library(ggplot2)
library(igraph)

opts_knit$set (root.dir=normalizePath('../'))
opts_chunk$set (fig.path = "./figures/08/")
opts_chunk$set (cache.path = "./cache/08/")
opts_chunk$set (fig.width = 11, 
                fig.height = 9,
                out.width = "858px")
```


```{r}
# load utility functions
nn <- list.files("./code/functions", full.names = TRUE) %>% lapply(source)
# load netw
net <- list.files("./data/networks/", full.names = TRUE) %>%
    lapply(readRDS)
names(net) <- list.files("./data/networks/", full.names = FALSE) %>%
    stringr::str_split("\\.") %>% lapply(`[`, 1) %>% unlist ()
```

With the redundancy. What are the differences between the invaded and the non-invaded sites?

Base data frame

```{r}
node_redundancy <- read.csv(file = "./data/node_redundancy.dat")

inv <- dplyr::data_frame(net_name = unique(node_redundancy$net) %>% as.character(),
												 inv = grepl("2", net_name) | grepl("4", net_name)) %>% 
	dplyr::mutate(site = rep(c("BAT", "FRA", "MED", "FAR", "MIQ", "SEL"), each =2),
								invader = rep(c("car", "op", "car", "op"),  c(2, 2, 4, 4)))

inv <- plyr::ldply(net, function(x){
	data.frame(n_pla = sum(igraph::V(x)$type == "pla"),
						 n_pol = sum(igraph::V(x)$type == "pol"))
}) %>% dplyr::add_rownames() %>%
	dplyr::rename(net = rowname, 
								net_name = .id) %>% dplyr::full_join(inv)
```

Save ntw metadata
```{r}
write.csv(inv, "./data/ntw_info.csv", row.names = F)
```

```{r}
# generate parameter space
space <- expand.grid(type = c("z-bi", "weight", "AB", "BA"), 
                                         net = 1:length(net)) %>%
    dplyr::inner_join(data.frame(type = c("z-bi", "AB", "BA", "weight", "weight"),
                                                             keep = c("all", "A", "B", "A", "B")))

# select the corresponding one for this computation

driver_nodes <- 1:nrow(space) %>%
	plyr::laply(function(i){
		p <- space[i,]
		n <- net[[p$net]] %>%
			keep_largest_component() %>%
			bipartite_digraph(type = p$type, keep = p$keep)
		igraph::E(n)$weight <- 1
		n %>%
			n_unmatched_vertex()
	})

space %<>%
    dplyr::mutate(n_driver = driver_nodes,
                                type = interaction(type, keep))

net_names <- plyr::ldply(net, function(x){
    length(igraph::V(x))
}) %>%
    dplyr::mutate(net = 1:nrow(.)) %>%
    dplyr::rename(n_species = V1,
                                net_name = `.id`)

space <- dplyr::inner_join(space, net_names) %>%
    dplyr::mutate(n_no_driver = n_species - n_driver)
```


Let's see if there is a difference in the proportion of needed species by invasion type

```{r}
space %<>%
	dplyr::mutate(prop_driver = n_driver/n_species) %>%
	dplyr::inner_join(inv)
```

```{r}
library(scales)

pdf("./presentation_figures/bp_n_drivers.pdf", width = 8, height = 5.5)
space %>%
	dplyr::filter(type == "weight.A") %>%
	ggplot() +
	geom_boxplot(aes(y = prop_driver, x = inv, fill = inv), size = 1, width = 1) +
	theme_minimal() + 
	theme(legend.position = "none",
				axis.title = element_blank(), 
				axis.text = element_text(size = 16)) +
	scale_x_discrete(labels= c("uninvaded", "invaded")) +
	scale_y_continuous(labels = percent) +
	scale_fill_manual(values = c("#377eb8", "#e41a1c"))
dev.off()

pdf("./presentation_figures/bp_n_drivers_poster.pdf", width = 14.5, height = 5.5)
space %>%
	dplyr::filter(type == "weight.A") %>%
	ggplot() +
	geom_boxplot(aes(y = prop_driver, x = inv, fill = inv), size = 1, width = 1, alpha = 0.75) +
	ylab("prop. management \ntarget species\n ") +
	theme_minimal() + 
	theme(legend.position = "none",
				axis.title.x = element_blank(), 
				axis.text = element_text(size = 44),
				axis.title.y = element_text(size = 44)) +
	scale_x_discrete(labels= c("uninvaded", "invaded")) +
	scale_y_continuous(labels = percent) +
	scale_fill_manual(values = c("#377eb8", "#e41a1c"))
dev.off()


lme4::glmer(cbind(n_driver, n_no_driver) ~ inv + (1|type) , data = space, family = "binomial") %>%
	summary()
```

Let's try again

```{r}
s_diff <- space %>% 
	arrange(inv) %>%
	group_by(site, type) %>%
	summarise(dif = diff(qlogis(prop_driver)), 
						invader = unique(invader))

s_diff %>%
	ggplot(aes(x = dif)) +
	geom_density()

lme4::lmer(dif ~ invader + (1|type) , data = s_diff) %>%
	summary()
```

No. No differences on the proportion of driver nodes between invaded and un-invaded systems, though almost... The proportion is a bit higher for the invaded system, but we don't have enough replicates to see if it's significant or not. 

## Composition differences

Let's look at the number of critical/redundant species

```{r}
node_redundancy %>%
	dplyr::mutate(type = paste(type, keep, sep = ".")) %>%
	dplyr::rename(net_name = net) %>%
	dplyr::group_by(net_name, type, robustness) %>%
	dplyr::summarise(n = n()) %>%
	dplyr::group_by() %>%
	dplyr::left_join(space)


```

