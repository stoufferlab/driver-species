---
title: "Read redundancies"
author: "Fernando Cagua"
date: "12 September 2015"
output: html_document
---

```{r, echo = FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(magrittr)
library(knitr)
library(ggplot2)
library(ggtern)

opts_knit$set (root.dir=normalizePath('../'))
opts_chunk$set (fig.path = "./figures/05/")
opts_chunk$set (cache.path = "./cache/05/")
opts_chunk$set (fig.width = 11, 
                fig.height = 9,
                out.width = "858px")
```

```{r}
# load utility functions
nn <- list.files("./code/functions", full.names = TRUE) %>% lapply(source)
# load netw
net <- list.files("./data/networks/", full.names = TRUE) %>%
	lapply(readRDS)
names(net) <- list.files("./data/networks/", full.names = FALSE) %>%
	stringr::str_split("\\.") %>% lapply(`[`, 1) %>% unlist ()
```

Let's have a look at the diferences in number of driver nodes of the different methods.

```{r, warning = FALSE}
# generate parameter space
space <- expand.grid(type = c("z-bi", "weight", "AB", "BA"), 
										 net = 1:length(net)) %>%
	dplyr::inner_join(data.frame(type = c("z-bi", "AB", "BA", "weight", "weight"),
															 keep = c("all", "A", "B", "A", "B")))
# select the corresponding one for this computation

driver_nodes <- 1:nrow(space) %>%
	plyr::laply(function(i){
		p <- space[i,]
		n <- net[[p$net]] %>%
			keep_largest_component() %>%
			bipartite_digraph(type = p$type, keep = p$keep)
		igraph::E(n)$weight <- 1
		n %>%
			n_unmatched_vertex()
	})

space %<>%
	dplyr::mutate(n_driver = driver_nodes,
								type = interaction(type, keep))

net_names <- plyr::ldply(net, function(x){
	length(igraph::V(x))
}) %>%
	dplyr::mutate(net = 1:nrow(.)) %>%
	dplyr::rename(n_species = V1,
								net_name = `.id`)

space <- dplyr::inner_join(space, net_names) %>%
	dplyr::mutate(n_no_driver = n_species - n_driver)

glm(cbind(n_driver, n_no_driver) ~ type,  data = space, family = "binomial") %>% summary

```


This means, 

 * ~ 74% of the species for Pla-Pol or Pol-Pla 
 * ~ 67% of the species for weighted (regardless of priority)
 * ~ 50% of the species for bi-directional 

Which is quite an improvement.

# Node redundancy

Now let's have a look at the proportion of critical, redundant and ordinary nodes in each class. 

```{r, warning = FALSE}
folder <- "./data/redundancy/node/"

node_redundancy <- list.files(folder, full.names = TRUE) %>%
	plyr::ldply(function(x, name){
		y <- read.csv(x) 
		info <- basename(x) %>% 
			stringr::str_sub(end = -5) %>% 
			stringr::str_split("_") %>% 
			unlist()
		y %>%
			dplyr::mutate(net = info[[1]],
										type = info[2],
										keep = info[3])
	}) 

ggplot(node_redundancy) +
	geom_bar(aes(x = interaction(type, keep), fill = robustness)) +
	facet_wrap(~ net, scales = "free", nrow = 2) +
	scale_fill_brewer(palette = "Set1")

node_redundancy %>%
	dplyr::mutate(type = interaction(type, keep)) %>%
	dplyr::group_by(net, type, robustness) %>%
	dplyr::summarise(n = n()) %>%
	tidyr::spread(robustness, n) %>%
	dplyr::mutate(critical = replace(critical, is.na(critical), 0),
								ordinary = replace(ordinary, is.na(ordinary), 0)) %>%
	ggplot(aes(x = ordinary, z = redundant, y = critical)) +
	geom_point(aes(fill = type), shape = 21, size = 5, alpha = 0.7) + 
	facet_wrap(~ net) +
	coord_tern() + 
	scale_fill_brewer(palette = "Set1")

inv <- dplyr::data_frame(net = unique(node_redundancy$net) %>% as.character(),
												 inv = grepl("2", net) | grepl("4", net)) %>% 
	dplyr::mutate(site = rep(c("BAT", "FRA", "MED", "FAR", "MIQ", "SEL"), each =2),
								invader = rep(c("car", "op", "car", "op"),  c(2, 2, 4, 4)))

nr <- node_redundancy %>%
	dplyr::mutate(type = interaction(type, keep)) %>%
	dplyr::group_by(net, type, robustness) %>%
	dplyr::summarise(n = n()) %>%
	tidyr::spread(robustness, n) %>%
	dplyr::mutate(critical = replace(critical, is.na(critical), 0),
								ordinary = replace(ordinary, is.na(ordinary), 0)) %>%
	dplyr::filter(type == "weight.A") %>%
	dplyr::inner_join(inv) 

points <- 
	rbind(c(1, 0, 0, 100), 
				c(2, 100, 0, 0),
				c(3, 0, 100, 0),
				c(4, 100/3, 100/3, 100/3),
				c(5, 50, 0, 50), 
				c(6, 0, 50, 50),
				c(7, 50, 50, 0)) %>%
	data.frame() %>%
	`colnames<-`(c("id", "o", "c", "r")) %T>% {
		ggtern(data = ., aes(o, c, r)) +
			geom_text(aes(label = id))
	}

polygons <- 
	rbind(c(1, 1),
				c(1, 5),
				c(1, 4),
				c(1, 6),
				c(2, 2),
				c(2, 7),
				c(2, 4),
				c(2, 5),
				c(3, 3),
				c(3, 6),
				c(3, 4),
				c(3, 7)) %>%
	data.frame() %>%
	`colnames<-`(c("lab", "id")) %>%
	inner_join(points)

pdf("./presentation_figures/tern_net_poster.pdf", width = 14.5, height = 5.5)
ggplot() + 
		geom_polygon(data = polygons, aes(x = o, y = c, z = r,  fill = as.factor(lab)), colour = "black", size = 1) +
	geom_point(data = nr, aes(x = ordinary, z = redundant, y = critical), size = 8, shape = 21, fill = "white") +
	coord_tern()	 + scale_fill_manual(values = c("#4daf4a", "#377eb8", "#e41a1c")) +
	theme(text = element_blank())
dev.off()

pdf("./presentation_figures/tern_net_pres.pdf", width = 8, height = 5.5)
ggplot() + 
		geom_polygon(data = polygons, aes(x = o, z = c, y = r,  fill = as.factor(lab)), colour = "black", size = 1) +
	geom_point(data = nr, aes(x = ordinary, y = redundant, z = critical), size = 5, shape = 21, fill = "white", alpha = 0.9) +
	coord_tern()	 + scale_fill_manual(values = c("#4daf4a", "#377eb8", "#e41a1c")) +
	theme(text = element_blank())
dev.off()
```

In both  representations we can see that there is little variation among configurations with the same phylosophy. 

* For pla-pol or pol-pla all species are either redundant or ordinary
* There are some critical species in the weight configuration but most of them are redundant and ordinary to a lesser degree
* The bidirectional configuration makes a larger proportion of species critical species critical and almost all the other are redundant

# Save results

```{r}
write.csv(node_redundancy, file = "./data/node_redundancy.dat", row.names = F)
```


# Link redundancy

```{r}
folder <- "./data/redundancy/edge/"

link_redundancy <- list.files(folder, full.names = TRUE) %>%
	plyr::ldply(function(x, name){
		y <- read.csv(x) 
		info <- basename(x) %>% 
			stringr::str_sub(end = -5) %>% 
			stringr::str_split("_") %>% 
			unlist()
		y %>%
			dplyr::mutate(net = info[[1]],
										type = info[2],
										keep = info[3])
	}) 


link_redundancy %>%
	dplyr::mutate(type = interaction(type, keep)) %>%
	dplyr::group_by(net, type, robustness) %>%
	dplyr::summarise(n = n()) %>%
	tidyr::spread(robustness, n) %>%
	dplyr::mutate(critical = replace(critical, is.na(critical), 0),
								ordinary = replace(ordinary, is.na(ordinary), 0)) %>%
	dplyr::filter(type == "AB.A") %>%
	dplyr::inner_join(inv) %>%
	ggplot(aes(x = ordinary, z = redundant, y = critical)) +
	geom_point(aes(fill = inv), shape = 21, size = 5, alpha = 0.7) + 
	coord_tern() + 
	scale_fill_brewer(palette = "Set1")
```

