---
title: "Generate Networks"
author: "Fernando Cagua"
date: "17 August 2015"
output: html_document
---

```{r, echo = FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(magrittr)
library(knitr)

opts_knit$set (root.dir=normalizePath('../'))
opts_chunk$set (fig.path = "./figures/01/")
opts_chunk$set (cache.path = "./cache/01/")
opts_chunk$set (fig.width = 11, 
                fig.height = 9,
                out.width = "858px")
```

First I read the data. Here I'm assuming that the different sites are independent, that the `Round` column corresponds to different samplings days and that it's OK to estimate the total weight by adding `Number_of_visits_per6min` across `Round`

```{r}
data <- read.csv("./data/network_data/Bartomeus_Ntw_nceas.txt",sep="\t") %>%
	tbl_df() %T>% print(width = Inf)

ntw <- data %>%
	dplyr::mutate(pla = paste0("p_", Plant_id),
								pol = paste0("i_", Insect_id)) %>%
	dplyr::group_by(Site, pla, pol) %>%
	dplyr::summarise(weight = sum(Number_of_visits_per6min)) %>%
	dplyr::group_by() %T>%
	print()
```

Now let's convert it to an `igraph` network and calculate a bipartite maximal matching.

```{r}
m_match <- plyr::dlply(ntw, "Site", function(x){
	edg <- x %>% 
		dplyr::select(-Site)
	ver <- edg %>%
		dplyr::select(-weight) %>%
		tidyr::gather(type, name, pla, pol) %>%
		dplyr::distinct() %>%
		dplyr::select(name, type)
	
	net <- igraph::graph.data.frame(edg, directed = F, vertices = ver)
	list(net = net,
			 match = igraph::maximum.bipartite.matching(net))
})
```

Now let's have a look at the matching results

```{r}
plyr::ldply(m_match, function(x){
	data.frame(matching_size = x$match$matching_size,
						 n_pla = table(igraph::V(x$net)$type)["pla"],
						 n_pol = table(igraph::V(x$net)$type)["pol"],
						 n_int = length(igraph::E(x$net)$weight),
						 matching_weight = x$match$matching_weight,
						 sum_weight = sum(igraph::E(x$net)$weight))
}) %>% 
	dplyr::mutate(n_comb = choose(n_int, matching_size)) %>%
	kable
```

The matching size and number of interactions doesn't coincide with the ones previously used for the bipartite matching.