---
title: "Working title: Ecological network control"
classoption: a4paper
csl: journal-of-ecology.csl
output: 
  bookdown::pdf_document2: 
    keep_tex: yes
    number_sections: false
toc: false
header-includes:
- \usepackage{geometry}
# - \geometry{right=3in,marginparwidth=2.5in}
- \usepackage{setspace}
- \usepackage{float}
- \usepackage{booktabs}
- \usepackage{caption}
- \usepackage{lineno}
- \usepackage{xr}
- \externaldocument[S-]{supp-info}
documentclass: artikel1
bibliography: references.bib
---

\doublespacing
\linenumbers

**E. Fernando Cagua^1^, Kate L. Wootton^1,2^, Daniel B. Stouffer^1^**

^1^ Centre for Integrative Ecology, School of Biological Sciences, University of Canterbury, Private Bag 4800, Christchurch 8041, New Zealand

^2^ Current address: Department of Ecology, Swedish University of Agricultural Sciences, Box 7044, SE-750 07 Uppsala, Sweden

**Author for correspondence:** Daniel Stouffer (daniel.stouffer@canterbury.ac.nz) - +64 3 364 2729 - Centre for Integrative Ecology, School of Biological Sciences, University of Canterbury, Private Bag 4800, Christchurch 8140, New Zealand

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, 
                      warning = FALSE)
```

\newpage

# Introduction

A major goal in ecology is to understand the roles played by different species in the biotic environment.
Within community ecology, a complex-systems approach has led to the development of a variety analytical and simulation tools with which to compare and contrast the roles of species embedded in a network of interactions [@bascompte_assembly_2009; @stouffer_evolutionary_2012].
<!-- Add some older references as this is a long-standing research line; see the 2012 paper for some if you'd like. -->
A particularly relevant dimension of any species' role is its ability to alter the abundance of other species in the community—since changes of this nature impact ecosystem function and biodiversity, and might have knock-on effects on other processes and services.
This ability is often referred to as a species' "keystoneness" [refmissing]. 

A significant proportion of the network tools used to estimate species roles in this context rely on the assumption that there is a link between a given species' centrality—a relative ranking of its importance that stems from social network research—and its ability to alter the abundances of other species. 
Taken at face value, the basis of this assumption is reasonably clear: a major justification for representing ecological communities as networks is the idea that the abundance of a species depends on the abundance of its neighbours (those species with which it interacts) and, by extension, the abundance of its neighbours' neighbours, and so on. 
By definition, more central species are better connected and hence should be more likely to affect the abundance of other species in the network.

<!-- Beware that the paragraph above could rub some readers/reviewers (those that believe in the usefulness of centrality) the wrong way. -->

<!-- I believe it should be 'keystoneness' and not 'keystoness'. I've tried to correct all, but please check this. -->

<!-- I didn't do it, but I would think about joining the text below (up to "more mechanistically-grounded") with the above to make a single paragraph. It'd be long, but the thoughts flow well. -->

Though conceptually intuitive, the relationship between centrality and keystoneness is largely phenomenological. 
On one hand, there is more than a dozen indices of centrality used in ecology. 
Choosing a particular metric can be a difficult task, especially because to date there are no clear methods to determine the suitability of an index to a particular application.
<!-- I feel like the question of there being so many centralities distracts from the main line of thinking. You could arguably emphasize the phenomenological piece better (with an example?) and jump straight to the sentence below this comment. -->
Furthermore, recent studies have shown that definitions of keystoneness based on centrality might not adequately predict the cascading extinctions keystone species are usually associated to. 
As a result, community ecology could arguably benefit from an alternative, more mechanistically-grounded, approach to understand how species affect each other's abundance. 

Species abundances are also influenced by the specific dynamic relationships between nodes and the mechanisms of self-regulation; however, community and population dynamics can be modelled in innumerable ways, and empirical support for one versus another is often still ambiguous. 
The alternative approach should therefore acknowledge ecosystem dynamics, but without being overly dependent on the particular choices of how they are characterised.
Among the various possibilities, *control theory* appears to be a strong candidate [@isbell_human_2013]. 
Control theory is a widely-studied branch of engineering used to determine and supervise the behaviour of dynamical systems [@motter_networkcontrology_2015]. 
It is inherently designed to deal with system feedbacks and its application has recently been expanded to complex networks [@liu_control_2016]. 
In concordance with long-standing ecological questions, advances in this field have established a clear link between the structure of the network and the way nodes affect each other. 
Unlike centrality indices, however, this link is not based on a priori assumptions between network metrics and keystoneness but is instead based on well-established advances in both dynamical and complex-systems theory.
<!--STOUFFER: Are we shooting ourselves in the foot since this isn't entirely true? That is, see comments from ELE about linearity and otherwise. CAGUA: How about this modified phrasing? DBS: I approve. ;)-->.

Despite the apparent overlap, the concepts and approaches of control theory are not yet commonly applied in an ecological context. 
Possibly, this is in part because research on the control of complex networks is generally more concerned with the state of the system as a whole. 
This is, in contrast with the interest in ecological roles, where the focus is on the nodes that compose the network.
At its fundamental level, control theory first determines whether a system is controllable or not; that is, it asks if a system can be driven to a desired state within a finite amount of time. 
Although the controllability of a network is a whole-system property, it has been recently shown that asking for the controllability of a complex-system is equivalent to finding a particular set of nodes: the set with which is possible to control the state of the whole network.
Notably, this set of nodes is not always unique for a given network.
This implies that an examination of the distinct sets provides a means to connect nodes with its *general* ability to modify the system to which they belong.

<!-- I feel like the paragraph above is trying to tell me two things and does neither very clearly. My gut tells me that it could probably be improved by removing the first sentence and worrying less about why it hasn't but ways in which the application to ecology could be improved. Does that make sense? -->

Here, we apply methods from control theory to a particular ecological problem and show how it can be used to gain insight into the role of species in an ecological network. 
Specifically, we outline the approach using a set of ten pairs of uninvaded and invaded plant-pollinator communities. 
We use invaded communities because there is strong empirical evidence showing that invasive species play an important role shaping the abundances of other species, something which is particularly true in these ten networks [@lopezaraizamikel_impact_2007; @bartomeus_contrasting_2008-1]. 
This choice thus offers us an opportunity to explicitly contrast our theoretical observations with empirical evidence.
With these network, we first ask whether there are differences between the controllability of invaded and uninvaded networks. This question is motivated by in the difficulties commonly encountered with invasive-species eradication and ecosystem restoration [@woodford_confronting_2016].
<!--STOUFFER: I'd remove the grounded in.... stuff, but that's just me.  CAGUA: I don't like it either. I tried removing but then it feels like this question is coming out of the blue.-->
We then expand existing methods from control theory to effectively link the *controllability* of a network with the role of particular species.
We ask—from a control-theoretic perspective—whether there are key differences between species in the role they play at driving the population of other members of the community and identify the ecological factors related to these differences. 
Finally, we compare the proposed approach to current methods based on species centrality and show how these methods are indeed valuable but ultimately paint a limited picture in regards to the dynamic "keystoneness" of a species.

# Methods

```{r load-metadata}
drake::loadd(metadata)
lop <- dplyr::filter(metadata, study == "lopezaraiza") %>% 
  dplyr::mutate(size = n_pla + n_pol) %$% size %>% summary() 
bar <- dplyr::filter(metadata, study == "bartomeus") %>% 
  dplyr::mutate(size = n_pla + n_pol) %$% size %>% summary() 
```

We used ten paired pollination communities to apply the control-theoretic approach.
Each community pair was composed of a community invaded by a plant and a community free of the invasive species. 
Four pairs correspond to natural or semi-natural vegetation communities in the city of Bristol, UK [@lopezaraizamikel_impact_2007]. 
These communities are comprised of `r lop[1]`--`r lop[6]` species (mean `r round(lop[4])`), and non-invaded plots were obtained by experimentally removing all the flowers of the invasive species *Impatients grandulifera*.
The other six pairs were obtained from lower diversity Mediterranean shrublands in Cap de Creus National Park, Spain [@bartomeus_contrasting_2008-1].
These communities are comprised of `r bar[1]`--`r bar[6]` species (mean `r round(bar[4])`); in contrast to the above, uninvaded communities were obtained from plots that had not yet been colonised by either of the invasive species *Carpobrotus affine acinaciformis* or *Opuntia stricta*. The structure of all these communities was defined by the pollinator visitation frequency, which has been shown to be an appropriate surrogate for interspecific effects in pollination networks [@vazquez_interaction_2005; @bascompte_asymmetric_2006]. 
Full details about the empirical networks, the implications of using visitation frequency to quantify the strength of the associations, and the sensitivity of the control-theoretic approach to undersampling of the interactions can be found in the supplementary information section \@ref(S-empirical-networks), XX, and XX. 

The first step in applying methods of control theory is to construct a directed network that is able to provide an indication of the extent to which species affect each other's abundance. 
In some ecological networks, establishing the directionality can be relatively straightforward, for example when links represent biomass transfer or energy flow [@isbell_human_2013]. 
In pollination networks, however, this directionality is less obvious as both species can, in theory, benefit from the interaction. 
We overcome that obstacle by noting that the extent to which species *i* affects species *j* relative to the extent to which *j* affects *i* can be summarised by the interaction asymmetry [@bascompte_asymmetric_2006]. 
This asymmetry is given by $$a(i,j) = a(j,i) = \frac{\left | d_{ij}-d_{ji} \right |}{max\left ( d_{ij}, d_{ji} \right )},$$ where the dependence of plant *i* on pollinator *j*, *d~ij~*, is the proportion of the visits from pollinator *j* compared to all pollinator visits to plant *i*. 
Previous research has shown that mutualistic interactions are often highly asymmetric in natural communities; in other words, if a plant species is largely dependent on a pollinator species, that pollinator tends to depend rather weakly on the plant (and vice versa). 
We, therefore, create a directed link between species *i* and *j* when $d_{ij}-d_{ji} \geq 0$ to establish the most likely direction of control between a species pair (Figure \@ref(fig:fig-example-networks)a).
<!-- The sentence above is slightly ambiguous. Shouldn't it say "create a directed link from species *i* to species *j*"? -->
Sometimes there is no observed asymmetry between species pairs ($d_{ij}=d_{ji}$), and we cannot infer a dominant  direction of control. 
When this occurs, we deem both species to be equally likely to affect each other and create two directed links between them, one from *i* to *j* and another from *j* to *i*. 
By basing the direction of the links on the asymmetry of their dependence, we are able to generate a network that is consistent with the dynamics of the community while satisfying the requirements of structural controllability. 

```{r}
drake::loadd(fig_struct_control)
```

```{r fig-example-networks, fig.width=fig_struct_control$width, fig.height=fig_struct_control$height, fig.cap="Direction of control and controllability conditions. (a) To establish the direction of control we start with a weighted visitation network (on the left). In this network, the width of the links corresponds to the frequency of visitation between animals $a_i$ and plants $p_i$, with wider link indicating more visits. Plant $p_1$ is visited exclusively by $a_1$ but $p_1$ represents only a small fraction of the floral resources of $a_1$. Therefore the population of $p_1$ is more likely to be affected by $a_1$ than visceversa. We represent this with a directed link from $a_1$ to $p_1$ (right). The direction of control between all other species pairs can be similarly determined by inspecting the difference between their relative dependences. (b) Once we have established the directions of control we can determine wether the network is controllable or not. A system defined by a directed network (with state nodes $x_i$; species populations in an ecological context) and external control inputs (nodes $u_i$, orange links) is structurally controllable if it satisfies two conditions: it has no dilations (expansions in the network) and no inaccessible nodes. The system on the top left is not controllable because there is a dilation in which node $x_2$ is being used to control two nodes simultaneously, in other workds there are less superiors ($x_2$) than subordinates ($x_1$ and $x_3$). The network in the top right is not controllable because node $x_3$ is inaccessible for the only input node $u_1$ in the system. Both systems can be made controllable by adding an extra input node (top)."}
replayPlot(fig_struct_control$plot)
```

After constructing the directed network, we can now calculate the controllability of the different networks and investigate whether there are differences between invaded and uninvaded communities. 

<!-- The sentence above needs a paragraph to belong to. It's too lonely. Seriously. -->

## Controllability

A system is said to be controllable if it is possible to steer it from an initial to an arbitrary final state within finite time [@kalman_mathematical_1963]. 
<!-- The sentence above and the sentence below both work well as leading sentences for a paragraph but neither works well as a second. Can you find somewhere to fold the one above into the paragraph (or elsewhere) or rewrite the beginning of the one below? -->
A simple dynamic system can be described by $\frac{dx}{dt} = Ax + Bu(t)$, where the change of its state over time ($\frac{dx}{dt}$) depends on its current state *x* (for example, the species' abundances), an external time-varying input *u(t)* (the control signal), and two matrices *A* and *B*, which encode information about the network structure and how species respond to external inputs, respectively. 
In classic control theory, determining wether this system is controllable can be achieved by checking that its controllability matrix $R= [ \begin{matrix}B & AB & A^{2}B & ...& A^{n-1}B\end{matrix} ]$ has full rank. 
In complex systems, however, employing this rank condition, or numerical approximations of it, is infeasible because it is hard to fully parameterize *A* and *B* (either because the weight of the links changes over time or because they are difficult to measure). 
Here we use an approach based on the structural controllability theorem [@lin_structural_1974], which assumes that we are confident about which elements of *A* and *B* have either non-zero or zero values (there is an interaction or not), but that we less sure about the precise magnitude of the non-zero values. 
Using this structural approach we can find out the controllability of a system under almost all non-zero parameter realisations.
Structural controllability also has a graphical interpretation that allows us to translate the control problem into a topological one: a network is controllable if there are no inaccessible nodes—nodes without incoming links—or dilations—*expansions* of the network (Figure \@ref(fig:fig-example-networks)b; Supplementary Information section \@ref(S-structural-controllability)).
<!-- The last sentence of the paragraph above sticks out a bit. -->

We are often able to estimate *A* in ecological networks, as this matrix represents the interactions between species. 
Part of the control problem resides in estimating a supportable estimation of *B*, which represents the links between external inputs and species. 
Naively, any ecological community (and any system for that matter) could be controlled if we control the state of every species independently, but such an approach is typically impractical. 
Here, we are interested in finding a minimum driver node-set (effectively finding *B*) with which to make the system controllable. 
The brute-force search for this minimum driver node set is computationally prohibitive for most networks as it involves the evaluation of $2^N$ different controllability matrices. 
We therefore instead employ a recently-developed approach that shows that the control problem of finding the minimum driver node set can be mapped into a graph-theoretic problem: maximum matching [@liu_controllability_2011; @liu_control_2016].

Maximum matching is a widely studied topic in graph theory and is commonly used in multiple applications, ranging from dating apps and wireless communications to organ transplant allocation and peer-to-peer file sharing. 
A matching in an unweighted directed graph is defined as a set of links that do not share a common start or end nodes; the largest possible matching is called a maximum matching. 
For example, in a network composed by jobs and job applicants, a matching is any pairing between applicants and positions that satisfies one basic constraint: an applicant can be assigned to at most one position and vice versa.
Consequently, a maximum matching is an optimal pairing, one that maximises the number of applicants with jobs and the number of positions filled. 
Admittedly, the link between matchings and structural controllability may appear far from straightforward. 
The key is to note that the fundamental conditions of structural controllability imply that there is a one-to-one relationship between *superior* and *subordinate* nodes just like the one-to-one relationship between jobs and applicants (Figure \@ref(fig:fig-example-networks)b, bottom left). 
We thus use the maximum-matching algorithm to find an optimal pairing of superior and subordinate nodes in a manner consistent with the controllability conditions (supplementary information section \@ref(S-one-maximum-matching)). 
Given the result, we can further decompose the matching into a set of paths that reveal how a control signal can flow across the links in a network to reach every node that composes it. 
As recently shown [@liu_controllability_2011], the minimum driver node set---those to which an external control input should be applied to make the system controllable---corresponds exactly to the *unmatched* nodes in the network (Figure \@ref(fig:fig-control-configuration)).

```{r}
drake::loadd(fig_control_config)
```

```{r fig-control-configuration, fig.height=fig_control_config$height, fig.width=fig_control_config$width,fig.cap = "Maximum matchings and control configurations. In directed networks, a maximum matching is the largest possible set of links that do not share start or end nodes (dark purple). Maximum matchings are not necessarily unique, instead, each of them is related to a possible minimum driver node set in the network (the nodes to which an external control input, in orange, should be applied in order to ensure controllability). The size of the minimum driver node set *D* corresponds exactly to the number of unmatched nodes (the number of nodes in the network *N* minus the matching size). To account for network size, we use the size of the minimum driver node set relative to the total number of nodes *n~D~ = D/N* as a measure of the extent to which the network structure can be harnessed to control the system."}
replayPlot(fig_control_config$plot)
```

## Differences between invaded and uninvaded networks

Our first ecological objective is to investigate whether the controllability of a community is associated with invasion status or not. 
Finding out exactly how difficult it is to control a network depends strongly on the particularities of the desired control trajectory as well as the dynamical relationship between nodes. 
However, we are interested in understanding the controllability of a network in a more general sense, such that it can be applied even when the precise control scenario is known only incompletely. 
To this end, we chose an indicator that follows directly from our approach: the size of the minimum driver node set. 
This simple metric provides a general indication of how difficult controlling a network might be, as systems that require a large number of external inputs to be fully controlled are intuitively more difficult or costly to manage. 
Specifically, drawing from the structural-controllability literature, we use the size of the minimum driver node set relative to the total number of nodes $n_D = \frac{D}{N}$ as a measure of the extent to which the network structure can be harnessed to control the community.
In an ecological context, external inputs can be thought of as management interventions that modify the abundance of a particular species. 
<!-- Would the two sentences below work better after the "Finding out exactly how difficult..." sentence? -->
For instance, achieving full control in a "network" in which species do not interact at all is relatively difficult as we would require an intervention for every single species. 
Conversely, the structure of a linear trophic chain can be harnessed to achieve full control using just one intervention targeted the top species; the control signal would then cascade through the trophic levels and reach other species in the community. 

After finding the minimum driver node set in each of our networks, we want to test whether invasion status or other predictors are correlated to this metric of controllability. 
We, therefore, use a set of generalised linear models (with binomial error structure) to investigate the effect of invasion status while also including covariates related to species richness, since one might naively expect to see a negative relationship between richness and controllability [@menge_indirect_1995]. 
These covariates included the total number of species, plant richness, pollinators richness, the ratio of plant to pollinator richness, the link density (connectance), and the study site (as a two-level factor). 
In addition, we also explored whether real networks differ in their architecture from random ones in a concerted way that could impact these results (supplementary information section \@ref(S-randomisations)).
<!-- Expand -->

## Species roles

Our second key question is related to how species differ in their ability to drive the population dynamics of the community.
Ecologically, these differences are relevant because resources and data are limited, and therefore full control is unfeasible. 
While calculating the size of the minimum drive node set can measure the controllability of an ecological community, it does not provide information about the roles that particular species play. 
To answer our question, we make two kinds of distinctions between species from a control perspective. 

First, we harness the fact there may be multiple maximum matchings for a given network, and each of these maximum matchings indicates unique paths that could potentially be used to control the network. 
Specifically, we use the frequency with which a species is part of the multiple minimum driver node sets---its control capacity $\phi$---as an estimation of its relative importance in driving the state of the community as a whole [@jia_control_2013]. 
For example, a species with a control capacity $\phi_i= 1$ is a one that requires external input in every single control configuration. 
This is, if we were to drive the community to an arbitrary alternate state, we would need to apply a management intervention to this species under *any* optimal control strategy. 

To calculate a species control capacity $\phi$, we need to enumerate all possible maximum matchings (we detail the algorithm to find all maximum matchings in the Supplementary Information section \@ref(S-all-maximum-matching)). 
However, enumerating all maximum matchings is extremely expensive from a computational perspective—a network with a couple dozen nodes could be controlled with several hundred million unique matchings. 
To solve this problem, we employ a recently-developed algorithm that reveals the control correlations between the nodes in the graph using considerably less computational resources [@zhang_input_2016, Supplementary Information section \@ref(S-input-graph)]. 
Using this algorithm, we are able to identify species that are possible control inputs—those that belong to the minimum driver node set in at least one of the possible control configurations. 
One of the original contributions of our work is to extend this algorithm such that it is possible to calculate a highly accurate approximation of the control capacity $\phi_i$ of every species in the network. 

<!-- The paragraph above reminded me of something in the back of my mind. Sometimes it's probably better to talk about species instead of nodes, even when we refer to aspects of graph theory. Could you go through and look carefully at every appearance of node to see if it would be easier for people that aren't us to understand if we said species instead? -->

A species control capacity $\phi$ allow us to identify species that are critical to change or maintain the state of the community. 
However, in ecological settings, changing the state of the community as a whole is often not required or undesired. 
Consequently, we make a second distinction between nodes based on whether they form part of possible control paths in the network and therefore are likely to influence the abundance of another species. 
We identify these species by checking whether they are classified as a superior node, this is they are at the beginning of a matched link. 
While unmatched nodes correspond to those that should be influenced with an external control input, superior nodes correspond to those that influence other species internally. 
Conveniently, with the exception of some pathological cases<!--expand or remove?-->, superior nodes always play this role across every control configuration, and therefore knowing one maximum matching provides enough information on whether a species is likely to play an important role at influencing the abundance of other species or not. <!--The end of this paragraph seems to just restate the end of the previous paragraph. What new info should I feel like I've gained but aren't?-->

<!-- You never formally define sigma. -->

To examine whether any species-level structural properties could predict a species control capacity $\phi$ and the likelihood of being a superior node $\sigma$, we calculated these properties for each of our networks.
In the networks that contained reciprocal links (because there was not assymetry in the dependences of a species pair), we averaged a species' $\phi$ and $\sigma$ across every possible "non-reciprocal" realisation of the network (more details can be found in the Supplementary Information section \@ref(S-reciprocal-links)). 
*TODO: Still need to decide how to do this and how to compare traditional centrality metrics to the new control based ones. Will probably base the comparison on stability/feasibility metrics or/and on coextinction of species groups.*
<!-- Do you really think there is enough time left to test these things in anything but a correlational fashion? -->

# Results

```{r controllability}
drake::loadd(controllability, metadata)
c_m <- controllability %>% 
  filter_networks_df(metadata)
```

The size of the minimum driver node set relative to the number of species in each network $n_D$ ranged between $n_D = `r round(min(c_m$n_D), 2)`$ and $n_D = `r round(max(c_m$n_D), 2)`$ (median `r round(median(c_m$n_D), 2)`, Figure \@ref(fig:fig-emp-controllability)). 
We found that the relative size of the minimum driver node set was not related to any of our independent variables. 
Indeed the null model ($n_D \sim 1$) was the most parsimonious candidate model and all variables were relatively unimportant (based on the AICc; Supplementary Information \@ref(S-controllability-models)). 

```{r fig-emp-controllability, fig.width=fig_sizes()[[1]], fig.height=fig_sizes()[[1]], fig.cap="Density plot of (a) the relative size of the minimum driver node set $n_D$ in the invaded (light) and uninvaded (dark) empirical networks. (b) The density distribution of the difference between the relative size of the minimum driver node set of random networks and that of empirical networks. We randomised either the species visitation patterns (light line), or randomised the direction of control between a species pair (dark line). The vertical dashed lines indicate the median values of each distribution."}
drake::loadd(fig_emp_controllability)

g <- fig_emp_controllability %>%
  purrr::map(ggplot2::ggplotGrob)
gb <- rbind(g[[1]], g[[2]], size = "first")
gb$widths <- grid::unit.pmax(g[[1]]$widths, g[[2]]$widths)
grid::grid.newpage()
grid::grid.draw(gb)
```


```{r, fig.width=fig_sizes()[[1]], fig.height=fig_sizes()[[1]], fig.cap="unfinished figure"}
drake::loadd(fig_species_level)

fig_species_level[[1]]
```

I'm thinlking just adding a graph with the control capacity and superiorness of the invasive/non invasive species as well as the glm to predict these variables and leave it there. 

That means that it would be necessary to modify the introduction to remove the parts that claim that centrality is not good enough to predict coextinction. 
The justification is just that centrality might just be telling a different thing to control. 
We then just use the "empirically known" role of invasive species to show it works? 

# References
