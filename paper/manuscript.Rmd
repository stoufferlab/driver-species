---
title: "Structural controllability of ecological networks"
classoption: a4paper
csl: journal-of-ecology.csl
output: 
  bookdown::pdf_document2: 
    keep_tex: yes
    number_sections: false
toc: false
header-includes:
- \usepackage{geometry}
# - \geometry{right=3in,marginparwidth=2.5in}
- \usepackage{setspace}
- \usepackage{float}
- \usepackage{booktabs}
- \usepackage{caption}
- \usepackage{lineno}
- \newcommand{\R}[1]{\label{#1}\linelabel{#1}}
- \newcommand{\lr}[1]{page~\pageref{#1}, line~\lineref{#1}}
- \usepackage{xr}
- \externaldocument[S-]{supp-info}
- \usepackage{siunitx}
- \usepackage{multirow}
- \usepackage{makecell}
- \usepackage{threeparttablex}
documentclass: artikel1
bibliography: phd-bibliography/network-control.bib
---

\doublespacing
\linenumbers

**E. Fernando Cagua^1^, Kate L. Wootton^1,2^, Daniel B. Stouffer^1^**

^1^ Centre for Integrative Ecology, School of Biological Sciences, University of Canterbury, Private Bag 4800, Christchurch 8041, New Zealand

^2^ Current address: Department of Ecology, Swedish University of Agricultural Sciences, Box 7044, SE-750 07 Uppsala, Sweden

**Author for correspondence:** Daniel Stouffer (daniel.stouffer@canterbury.ac.nz) - +64 3 364 2729 - Centre for Integrative Ecology, School of Biological Sciences, University of Canterbury, Private Bag 4800, Christchurch 8140, New Zealand

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, 
                      warning = FALSE)
options(knitr.kable.NA = '')
library(ggplot2)
```

```{r load-metadata}
drake::loadd(metadata)
lop <- dplyr::filter(metadata, study == "lopezaraiza") %>% 
  dplyr::mutate(size = n_pla + n_pol) %$% size %>% summary() 
bar <- dplyr::filter(metadata, study == "bartomeus") %>% 
  dplyr::mutate(size = n_pla + n_pol) %$% size %>% summary() 
```

*Alternative titles:* 

* Keystoneness, centrality, and the structural controllability of ecological networks

\clearpage

# Abstract

1. Background

2. Methods

3. Results

4. Synthesis

# Introduction

A major goal in ecology is to understand the roles played by different species in the biotic environment.
Within community ecology, a complex-systems approach has led to the development of a variety analytical and simulation tools with which to compare and contrast the roles of species embedded in a network of interactions [@guimera_cartography_2005; @bascompte_assembly_2009; @stouffer_evolutionary_2012; @coux_linking_2016].
A particularly relevant dimension of any species' role is its ability to alter the abundance of other species and the state of the community—since changes of this nature can have knock-on effects on ecosystem function, diversity, processes, and services.
This ability is sometimes referred to as a species' "keystoneness" [@mills_keystone-species_1993]. 

A significant proportion of the network tools used to estimate species roles in this context rely on the calculation of a species' centrality—a relative ranking of its positional importance that stems from social network research [@noah_e._friedkin_theoretical_1991]. 
Generally speaking, central species tend to be better connected and consequently are more likely to participate in the network's food chains. 
Because species that participate in more chains are assumed to be more likely to affect the abundance of other species, centrality metrics have often been used to identify keystone species in the community [@jordan_quantifying_2007]. 
Centrality metrics have been shown to be useful tools to rank species in regards to their potential to alter the abundances of other species; especially when estimating secondary extinctions that may follow the loss of a species [@dunne_network_2002; @kaiser-bunbury_robustness_2010].

Despite being conceptually intuitive, the relationship between centrality and the state of the community is largely phenomenological. 
On one hand, dramatic changes in ecosystem functioning can also occur without complete removal of a species. 
On the other, we are often interested in a *specific* state of the community that might be desirable to attain (or preserve) because of its biodiversity, resilience, functioning, or the services it provides. 
In these cases, it might not enough to understand which species may cause *any* change in the community. 
Rather we need to understand first, how the structure of the network can be harnessed to achieve the desired state and which species may play the largest role in this process. 
When the state of a community is underpinned by more than a single species and we move beyond single-species removals, we expect the usefulness of centrality to diminish. 
As a result, community ecology could arguably benefit from an alternative, perhaps more mechanistically-grounded, approach to understand how species affect each other's abundance. 

Species abundances (and consequently the state of the community) are influenced by both their interactions, the specific dynamics of these interactions and the mechanisms of self-regulation. 
However, community and population dynamics can be modelled in innumerable ways, and empirical support for one versus another is often still ambiguous. 
The alternative approach should, therefore, ideally acknowledge ecosystem dynamics, but without being overly dependent on the particular choices of how they are characterised.
Among the various possibilities, *control theory* appears to be a strong candidate [@isbell_human_2013]. 
Control theory is a widely-studied branch of engineering used to determine and supervise the behaviour of dynamical systems [@motter_networkcontrology_2015]. 
It is inherently designed to deal with system feedbacks and its application has recently been expanded to complex networks [@lin_structural_1974;  @liu_control_2016]. 
In concordance with long-standing ecological questions, advances in this field have established a clear link between the structure of the network and the way nodes affect each other. 
Unlike centrality indices, however, this link is not based on a priori assumptions between network metrics and keystoneness but is instead based on well-established advances in both dynamical and complex-systems theory.

At its fundamental level, control theory first determines whether a system is controllable or not; that is, it asks if a system can be driven to a desired state within a finite amount of time. 
Although the controllability of a network is a whole-system property, it has been recently shown that asking for the controllability of a complex-system is equivalent to finding a particular set of nodes: the set with which is possible to control the state of the whole network [@liu_control_2016].
Notably, control theory is consistent with the observation that to change the state of a network, more than a ranking, we need a set of nodes.
Importantly, this set of nodes is not always unique for a given network.
This implies that an examination of the distinct sets provides a means to connect nodes with its *general* ability to modify the system to which they belong.

Here, we apply methods from control theory to a particular ecological problem and show how it can be used to gain insight into the role of species in an ecological network. 
Specifically, we outline the approach using a set of ten pairs of uninvaded and invaded plant-pollinator communities. 
We use invaded communities because there is strong empirical evidence showing that invasive species play an important role shaping the abundances of other species, something which is particularly true in these ten networks [@lopezaraizamikel_impact_2007; @bartomeus_contrasting_2008-1]. 
This choice thus offers us an opportunity to explicitly contrast our theoretical observations with empirical evidence.
Empirical observations indicate that steering the state of some communities—for example during ecosystem restoration or invasive species removal—can be a very difficult task [@woodford_confronting_2016]. 
Therefore, with these networks, we first ask whether there are differences between the controllability of invaded and uninvaded networks. 
We then expand existing methods from control theory to effectively link the *controllability* of a network with the role of particular species.
We ask—from a control-theoretic perspective—whether there are key differences between species in the role they play at driving the state of the community and explore the ecological factors related to these differences. 
This allows us to identify species that might be critical for network control and show that they have a larger than expected impact on the structural stability of the community. 
Finally, we compare the proposed approach to current methods based on species centrality and show how these methods are indeed valuable but ultimately paint a limited picture in regards to the "keystoneness" of a species and its role at supporting the diversity of its community. 

# Methods


We used ten paired pollination communities to apply the control-theoretic approach.
Each community pair was composed of a community invaded by a plant and a community free of the invasive species. 
Four pairs correspond to natural or semi-natural vegetation communities in the city of Bristol, UK [@lopezaraizamikel_impact_2007]. 
These communities are comprised of `r lop[1]`--`r lop[6]` species (mean `r round(lop[4])`), and non-invaded plots were obtained by experimentally removing all the flowers of the invasive species *Impatients grandulifera*.
The other six pairs were obtained from lower diversity Mediterranean shrublands in Cap de Creus National Park, Spain [@bartomeus_contrasting_2008-1].
These communities are comprised of `r bar[1]`--`r bar[6]` species (mean `r round(bar[4])`); in contrast to the above, uninvaded communities were obtained from plots that had not yet been colonised by either of the invasive species *Carpobrotus affine acinaciformis* or *Opuntia stricta*. The structure of all these communities was defined by the pollinator visitation frequency, which has been shown to be an appropriate surrogate for interspecific effects in pollination networks [@vazquez_interaction_2005; @bascompte_asymmetric_2006]. 
Full details about the empirical networks can be found in the Supporting Information Section \@ref(S-empirical-networks). 

The first step in applying methods of control theory is to construct a directed network that is able to provide an indication of the extent to which species affect each other's abundance. 
In some ecological networks, establishing the directionality can be relatively straightforward, for example when links represent biomass transfer or energy flow [@isbell_human_2013]. 
In pollination networks, however, this directionality is less obvious as both species can, in theory, benefit from the interaction. 
We overcome that obstacle by noting that the extent to which species *i* affects species *j* relative to the extent to which *j* affects *i* can be summarised by the interaction asymmetry [@bascompte_asymmetric_2006]. 
This asymmetry is given by $$a(i,j) = a(j,i) = \frac{\left | d_{ij}-d_{ji} \right |}{max\left ( d_{ij}, d_{ji} \right )},$$ where the dependence of plant *i* on pollinator *j*, *d~ij~*, is the proportion of the visits from pollinator *j* compared to all pollinator visits to plant *i*. 
Previous research has shown that mutualistic interactions are often highly asymmetric in natural communities; in other words, if a plant species is largely dependent on a pollinator species, that pollinator tends to depend rather weakly on the plant (and vice versa). 
We, therefore, create a directed link from species *i* to species *j* when $d_{ij}-d_{ji} \geq 0$ to establish the most likely direction of control between a species pair (Figure \@ref(fig:fig-example-networks)a).
Sometimes there is no observed asymmetry between species pairs ($d_{ij}=d_{ji}$), and we cannot infer a dominant direction of control. 
When this occurs, we deem both species to be equally likely to affect each other and form a reciprocal interaction between them (a link from *i* to *j* and another from *j* to *i*). 
By basing the direction of the links on the asymmetry of their dependence, we are able to generate a network that is consistent with the dynamics of the community while satisfying the requirements of structural controllability. 
That allows us to calculate the controllability of the networks and investigate whether there are differences between invaded and uninvaded communities. 

```{r load-fig-example-networks}
drake::loadd(fig_struct_control)
```

```{r fig-example-networks, fig.width=fig_struct_control$width, fig.height=fig_struct_control$height, fig.cap="Direction of control and controllability conditions. (a) To establish the direction of control we start with a weighted visitation network (on the left). In this network, the width of the links corresponds to the frequency of visitation between animals $a_i$ and plants $p_i$, with wider links indicating more visits. Plant $p_1$ is visited exclusively by $a_1$ but $p_1$ represents only a small fraction of the floral resources of $a_1$. Therefore the population of $p_1$ is more likely to be affected by $a_1$ than vice-versa. We represent this with a directed link from $a_1$ to $p_1$ (right). The direction of control between all other species pairs can be similarly determined by inspecting the difference between their relative dependences. (b) Once we have established the directions of control we can determine whether the network is controllable or not. A system defined by a directed network (with state nodes $x_i$; species populations in an ecological context) and external control inputs (nodes $u_i$, orange links) is structurally controllable if it satisfies two conditions: it has no dilations (expansions in the network) and no inaccessible nodes. The system on the top left is not controllable because there is a dilation in which node $x_2$ is being used to control two nodes simultaneously, in other words, there are fewer superiors ($x_2$) than subordinates ($x_1$ and $x_3$). The network in the top right is not controllable because node $x_3$ is inaccessible for the only input node $u_1$ in the system. Both systems can be made controllable by adding an extra input node (top)."}
replayPlot(fig_struct_control$plot)
```

## Controllability

A system is said to be controllable if it is possible to steer it from an initial to an arbitrary final state within finite time [@kalman_mathematical_1963]. 
<!-- The sentence above and the sentence below both work well as leading sentences for a paragraph but neither works well as a second. Can you find somewhere to fold the one above into the paragraph (or elsewhere) or rewrite the beginning of the one below? -->
<!-- FDO: What about now Daniel? -->
A simple version of such a system can be described by $\frac{dx}{dt} = Ax + Bu(t)$, where the change of its state over time ($\frac{dx}{dt}$) depends on its current state *x* (for example, the species' abundances), an external time-varying input *u(t)* (the control signal), and two matrices *A* and *B*, which encode information about the network structure and how species respond to external inputs, respectively. 
In classic control theory, determining wether this system is controllable can be achieved by checking that its controllability matrix $R= [ \begin{matrix}B & AB & A^{2}B & ...& A^{n-1}B\end{matrix} ]$ has full rank. 
In complex systems, however, employing this rank condition, or numerical approximations of it, is infeasible because it is hard to fully parameterize *A* and *B* (either because the weight of the links changes over time or because they are difficult to measure). 
Here we use an approach based on the structural controllability theorem [@lin_structural_1974], which assumes that we are confident about which elements of *A* and *B* have either non-zero or zero values (there is an interaction or not), but that we less sure about the precise magnitude of the non-zero values. 
Using this structural approach we can find out the controllability of a system for every non-zero realisations of the parameters.
An intuitive way to understand structural controllability is by looking at its graphical interpretation: from a topological perspective a network is structurally controllable if there are no inaccessible nodes—nodes without incoming links—or dilations—*expansions* of the network (Figure \@ref(fig:fig-example-networks)b; Supporting Information Section \@ref(S-structural-controllability)).
<!-- The last sentence of the paragraph above sticks out a bit. -->
<!-- I rephrased it the last couple of sentences, hopefully, it flows better now -->

We are often able to estimate *A* in ecological networks, as this matrix represents the interactions between species. 
Part of the control problem resides in estimating a supportable estimation of *B*, which represents the links between external inputs and species. 
Naively, any ecological community (and any system for that matter) could be controlled if we control the state of every species independently, but such an approach is typically impractical. 
Here, we are interested in finding a minimum driver node-set (effectively finding *B*) with which to make the system controllable. 
The brute-force search for this minimum driver node-set is computationally prohibitive for most networks as it involves the evaluation of $2^N$ different controllability matrices. 
We therefore instead employ a recently-developed approach that shows that the control problem of finding the minimum driver node-set can be mapped into a graph-theoretic problem: maximum matching [@liu_controllability_2011; @liu_control_2016].

Maximum-matching is a widely studied topic in graph theory and is commonly used in multiple applications, ranging from dating apps and wireless communications to organ transplant allocation and peer-to-peer file sharing. 
A matching in an unweighted directed graph is defined as a set of links that do not share a common start or end nodes; the largest possible matching is called a maximum matching. 
For example, in a network composed by jobs and job applicants, a matching is any pairing between applicants and positions that satisfies one basic constraint: an applicant can be assigned to at most one position and vice versa.
Consequently, a maximum matching is an optimal pairing, one that maximises the number of applicants with jobs and the number of positions filled. 
Admittedly, the link between matchings and structural controllability may appear far from straightforward. 
The key is to note that the fundamental conditions of structural controllability imply that there is a one-to-one relationship between *superior* and *subordinate* nodes just like the one-to-one relationship between jobs and applicants (Figure \@ref(fig:fig-example-networks)b, bottom left). 
We thus use the maximum-matching algorithm to find an optimal pairing of superior and subordinate nodes in a manner consistent with the controllability conditions (Supporting Information Section \@ref(S-one-maximum-matching)). 
Given the result, we can further decompose the matching into a set of paths that reveal how a control signal can flow across the links in a network to reach every node that composes it. 
As recently shown [@liu_controllability_2011], the minimum driver node-set---those to which an external control input should be applied to make the system controllable---corresponds exactly to the *unmatched* nodes in the network (Figure \@ref(fig:fig-control-configuration)).

```{r load-fig-control-configuration}
drake::loadd(fig_control_config)
```

```{r fig-control-configuration, fig.height=fig_control_config$height, fig.width=fig_control_config$width,fig.cap = "Maximum matchings and control configurations. In directed networks, a maximum matching is the largest possible set of links that do not share start or end nodes (dark purple). Maximum matchings are not necessarily unique, instead, each of them is related to a possible minimum driver node-set in the network (the nodes to which an external control input, in orange, should be applied in order to ensure controllability). The size of the minimum driver node-set *D* corresponds exactly to the number of unmatched nodes (the number of nodes in the network *N* minus the matching size). To account for network size, we use the size of the minimum driver node-set relative to the total number of nodes *n~D~ = D/N* as a measure of the extent to which the network structure can be harnessed to control the system."}
replayPlot(fig_control_config$plot)
```

## Differences between invaded and uninvaded networks

Our first ecological objective is to investigate whether the controllability of a community is associated with invasion status or not. 
Finding out exactly how difficult it is to control a network depends strongly on the particularities of the desired control trajectory as well as the dynamical relationship between nodes. 
However, we are interested in understanding the controllability of a network in a more general sense, such that it can be applied even when the precise control scenario is known only incompletely. 
To this end, we chose an indicator that follows directly from our approach: the size of the minimum driver node-set. 
This simple metric provides a general indication of how difficult controlling a network might be, as systems that require a large number of external inputs to be fully controlled are intuitively more difficult or costly to manage. 
For instance, achieving full control in a "network" in which species do not interact at all is relatively more difficult as we would require an intervention for every single species. 
Conversely, the structure of a linear trophic chain can be harnessed to achieve full control using just one intervention targeted the top species; the control signal would then cascade through the trophic levels and reach other species in the community. 
Specifically, drawing from the structural-controllability literature, we use the size of the minimum driver node-set relative to the total number of species $n_D = \frac{D}{N}$ as a measure of the *controllability* of a network—the extent to which the network structure can be harnessed to control the community.
In an ecological context, external inputs can be thought of as management interventions that modify the abundance of a particular species. 
<!-- Would the two sentences below work better after the "Finding out exactly how difficult..." sentence? -->
<!-- I moved it to a different place where I think flows better -->

After finding the minimum driver node-set in each of our networks, we wanted to test whether invasion status or other predictors are correlated to controllability. 
We, therefore, use a set of generalised linear models (with binomial error structure). 
The response variable was the size of the minimum driver node-set $n_D$ of the twenty empirical networks (ten invaded and ten uninvaded) and we included invasion status as a predictor. 
We also include the network connectance, the network nestedness (NODF) the number of species [since one might naively expect to see a negative relationship between richness and controllability; @menge_indirect_1995], the network asymmetry (an indication of the balance between plant and pollinator diversity), and the interaction strength asymmetry [the asymmetry on the dependences between trophic levels; @bluthgen_specialization_2007].
Models were compared using the Akaike Information Criterion for small sample sizes (AICc). 

In addition, we also explored whether real networks differ in their architecture from random ones in a concerted way that could impact these results. 
Specifically, we used two null models each with 99 randomisations per network. 
In the first, we followed @vazquez_species_2007 and maintained the connectance of the network but randomised the visits across species such that the relative probabilities of interactions were maintained. 
We then calculated the direction of control and the corresponding size of the minimum driver node-set, $n_D$. 
For the second null model, we used the empirical directed network and randomly shuffled the direction of control between a species pair.

## Species roles

Our second key question is related to how species differ in their ability to drive the population dynamics of the community.
Ecologically, these differences are relevant because resources and data are limited, and therefore full control is unfeasible. 
While calculating the size of the minimum drive node-set can measure the controllability of an ecological community, it does not provide information about the roles that particular species play. 
To answer our question, we make two kinds of distinctions between species from a control perspective. 

First, we harness the fact there may be multiple maximum matchings for a given network, and each of these maximum matchings indicates unique paths that could potentially be used to control the network. 
Specifically, we use the frequency with which a species is part of the multiple minimum driver node-sets---its control capacity $\phi$---as an estimation of its relative importance in driving the state of the community as a whole [@jia_control_2013]. 
For example, a species with a control capacity $\phi_i= 1$ is a one that requires external input in every single control configuration. 
This is, if we were to drive the community to an arbitrary alternate state, we would need to apply a management intervention to this species under *any* optimal control strategy. 

To calculate a species control capacity $\phi$, we need to enumerate all possible maximum matchings (we detail the algorithm to find all maximum matchings in the Supporting Information Section \@ref(S-all-maximum-matching)). 
However, enumerating all maximum matchings is extremely expensive from a computational perspective—a network with a couple dozen species could be controlled with several hundred million unique matchings. 
To solve this problem, we employ a recently-developed algorithm that reveals the control correlations between the nodes in the graph using considerably less computational resources [@zhang_input_2016, Supporting Information Section \@ref(S-input-graph)]. 
Using this algorithm, we are able to identify species that are possible control inputs—those that belong to the minimum driver node-set in at least one of the possible control configurations. 
One of the original contributions of our work is to extend this algorithm such that it is possible to calculate a highly accurate approximation of the control capacity $\phi_i$ of every species in the network. 

<!-- The paragraph above reminded me of something in the back of my mind. Sometimes it's probably better to talk about species instead of nodes, even when we refer to aspects of graph theory. Could you go through and look carefully at every appearance of node to see if it would be easier for people that aren't us to understand if we said species instead? -->

A species control capacity $\phi$ allow us to identify species that are critical to change or maintain the state of the community. 
However, in ecological settings, changing the state of the community as a whole is often not required or undesired. 
Consequently, we make a second distinction between species based on whether they form part of possible control paths in the network and therefore are likely to influence the abundance of another species. 
We identify these species by checking whether they are classified as *superiors*, this is they are at the beginning of a matched link. 
While unmatched species correspond to those that should be influenced with an external control input, superior species correspond to those that influence other species internally. 
Conveniently, unlike the minimum driver node-set, superior species are the same for all control configurations and so in a network without reciprocal links (see below) the probability that a species is superior $\sigma$ is either 1 or 0.  <!--The end of this paragraph seems to just restate the end of the previous paragraph. What new info should I feel like I've gained but aren't?-->
<!-- You never formally define sigma. -->
<!-- CHanged wording to make it simpler and define sigma at the same time -->

We calculated the species control capacity $\phi$ and the probability of being superior $\sigma$ for each species in our networks.
In the networks that contained reciprocal links (because there was no asymmetry in the dependences of a species pair), we averaged a species' $\phi$ and $\sigma$ across every possible "non-reciprocal" realisation of the network (more details can be found in the Supporting Information Section \@ref(S-reciprocal-links)). 
We then examined how species-level structural properties were related to these two variables using two sets of generalised mixed-effects models with binomial error structure. 
As explanatory variables in the fixed component, we included four variables. 
First, the species contribution to nestedness, which has been proposed as a key feature that promotes stability and robustness in mutualistic networks [@saavedra_strong_2011]. 
Second, the visitation strength (the sum of a species' interactions), which quantifies the strength of a species associations and is indirectly related to its abundance [@poisot_comparative_2012]. 
Third, the direction of asymmetry which quantifies the net balance in dependencies, this is it indicates if a species affects other species more than what they affect it or not [@vazquez_species_2007]. 
Fourth, to account for the centrality of a species we included the degree as the fourth fixed effect. 
To facilitate comparison between variables, all four variables were scaled to have a mean of zero and a standard deviation of one. 
To identify the models that were best supported by the data we first determined the most parsimonious random structure using the AICc. 
Specifically, we evaluated a random intercept for observations grouped by the study site, and an intercept and slope for the contribution to nestedness, visitation strength and asymmetry grouped by the trophic guild (plant or pollinator). 
After identifying the most likely random structure we ranked models from all possible fixed effects combinations using the AICc weight. The relative importance of variables was then assessed by looking at both their effect sizes in the top-ranked models and the cumulative weight of the models in which they are present. 

Some species have a control capacity $\phi = 1$. 
These species are critical to controlling community because they are part of the minimum driver node-set in every control scenario. 
In other words, it is not possible to change the state of the community to a desired state without managing the abundance of these species. 
We anticipate that these species have a disproportionally large impact on the community dynamics. 
Therefore, we determined the critical species in each of the networks and investigated whether they have a larger than average impact on the stable coexistence of species in the community. 
This property of promoting stable coexistence is called structural stability [@rohr_structural_2014]. 
Mathematically it is denoted by the letter $\Omega$ and represents the size of the parameter space (growth rates, carrying capacities) under which all species can sustain positive abundances [@saavedra_nested_2016]. 
The contribution of species *i* to stable coexistence, can be estimated by calculating the structural stability of the community when the focal species *i* is removed. 
We then used a t-test to compare the contribution to stable coexistence of critical and non-critical species. 
More details about the calculation of structural stability can be found in the Supporting Information Section \@ref(S-structural-stability).

Finally, we wanted to understand how the control capacity $\phi$ and the probability of being superior $\sigma$ is related to metrics of keystoness based on centrality. 
To do that, for each network, we calculated the Spearman correlation matrix between these two variables and some centrality metrics commonly used to identify keystone species. 
Namely degree, betweenness, eigen centrality, page rank, and closeness centrality.

## Testing assumptions
 
\R{testing-assumptions-line}Just like the centrality metrics, the information obtained by applying structural controllability depends on the ability of the network to accurately represent the ecological community. 
We tested the sensitivity of our approach to two fundamental assumptions. 
First, we tested that visitation is an appropriate proxy to infer interspecific effects. 
To do that we compared the results obtained using visitation to two alternative metrics in a dataset that lacked invasive species [@ballantyne_constructing_2015]. 
Specifically, we also applied the structural controllability approach to networks constructed using pollinator efficiency (which measures the pollen deposition of an interaction) and pollinator importance [which accounts for both pollen deposition and visitation and hence is regarded as a more accurate estimation of the pollination service received by plants; @neeman_framework_2009]. More details in the Supporting Information Section \@ref(S-visitation-as-proxy). 
Second, because interspecific dependencies depend on the network topology and consequently on the accurate sampling of interactions, we tested the robustness of structural controllability to the uncertainity involved with the sampling of interactions. 
To do that we compared the results obtained when using the full network and when randomly removing interactions from the weakest links in the network. 
This effectively removed the rare interactions from the networks (more details in the Supporting Information Section \@ref(S-undersampling)). 

# Results

```{r controllability-calculations}
drake::loadd(controllability, metadata, randomisations_test)
c_m <- controllability %>% 
  filter_networks_df(metadata)
```

The size of the minimum driver node-set relative to the number of species in each network $n_D$ ranged between $n_D = `r round(min(c_m$n_D), 2)`$ and $n_D = `r round(max(c_m$n_D), 2)`$ (median `r round(median(c_m$n_D), 2)`). 
We found that the relative size of the minimum driver node-set of invaded communities was not significantly different to that of communities that have not been invaded (Figure \@ref(fig:fig-emp-controllability)a). 
However there was an important negative relationship between $n_D$ and the network asymetry (Figure \@ref(fig:fig-emp-controllability)b). 
Furthermore, there were also negative, albeit weaker, correlations between $n_D$ and connectance, nestedness and species richness (Table  \@ref(S-tab:tab-controllability-model-results)). 
The $n_D$ of empirical networks did not differ to that of a null model that roughly preserved the degree distribution and fully preserved the network connectance ($p = `r sprintf('\\num{%s}', format(randomisations_test$interactions$p.value, digits = 2))`$; Figure \@ref(fig:fig-emp-controllability)b). 
However empirical networks had a larger $n_D$ than null models that preserved the interactions but shuffled the direction of control of the empirical network ($p = `r sprintf('\\num{%s}', format(randomisations_test$directions$p.value, digits = 2))`$). 

```{r fig-emp-controllability, fig.width=fig_sizes()[[1]], fig.height=fig_sizes()[[1]]*1.5, fig.cap="Density plot of (a) the relative size of the minimum driver node-set $n_D$ in the invaded (light) and uninvaded (dark) empirical networks. (b) Relationship between the asymmetry plant/pollinator richness and $n_D$. The plot shows the values predicted by the most parsimoniouls model. (c) The density distribution of the difference between the relative size of the minimum driver node-set of random networks and that of empirical networks. We randomised either the species visitation patterns (light line) or randomised the direction of control between a species pair (dark line). The vertical dashed lines indicate the median values of each distribution."}
drake::loadd(fig_emp_controllability)
cowplot::plot_grid(plotlist = fig_emp_controllability, 
                   ncol = 1, 
                   align = "v")
```

```{r cirtical-species-descriptive}
drake::loadd(sl_characteristics)
crit <- sl_characteristics %>% 
  filter_networks_df(metadata) %>%
  dplyr::group_by(net_name) %>%
  dplyr::summarise(n_crit = sum(control_capacity == 1), 
                   n_sp = n()) %>%
  dplyr::mutate(p_crit = n_crit/n_sp)

pcrit_ran <- range(crit$p_crit)
ncrit_ran <- range(crit$n_crit)
pcrit_med <- median(crit$p_crit)
```

The models that best explained a species control capacity $\phi$, had a random intercept and slope for the species asymmetry grouped by the species' guild (plants or pollinators; Table \@ref(S-tab:tab-species-model-random), Table \@ref(S-tab:tab-model-output-species-level)). 
Contribution to nestedness was the most important variable followed by visitation strength (Table \@ref(tab:tab-model-selection-table), Table \@ref(S-tab:tab-var-importance)) with species with large contribution to nestedness and large visitation strength being more likely to have a large control capacity (Figure \@ref(fig:fig-species-level)a and b). 
For the probability of being a superior species $\sigma$, the most parsimonuous models did not include any random effect Table \@ref(S-tab:tab-species-model-random), Table \@ref(S-tab:tab-model-output-species-level)). 
The most important variables were the species asymmetry and the visitation strength (Table \@ref(tab:tab-model-selection-table), Table \@ref(S-tab:tab-var-importance)). 
Specifically, species with a positive asymmetry (this is they affect their partners more than what their partners affect them), and with a large visitation strength were more likely to be superior (Figure \@ref(fig:fig-species-level)c and d). 
Furthermore, species degree was positively, but only weakly associated with both control capacity and the probability of being a superior species. 
Remarkably, many species with a low degree, especially pollinators attained a large control capacity in their communities (Figure \@ref(S-fig:fig-species-models-degree)). 
In addition all invasive plants were both critical ($\phi = 1$) and were superior ($\sigma = 1$) species in their communities.

```{r tab-model-selection-table}
drake::loadd(species_model_cc, species_model_superior)

cc_table <- MuMIn::model.sel(species_model_cc$fixed) %>%
  dplyr::filter(weight > 0.01)
su_table <- MuMIn::model.sel(species_model_superior$fixed)%>%
  dplyr::filter(weight > 0.01)

dplyr::bind_rows(cc_table, su_table) %>%
  dplyr::select(-logLik, - AICc) %>%
  knitr::kable("latex", 
               col.names = c("int.", "deg.", "asy.", "nes.", "str.", "d.f.",  "$\\Delta$AICc","weight"),
               booktabs = T, 
               caption = "Selection table of the generalised mixed effect models of control capacity $\\phi$ and the probability of being a superior species $\\sigma$. Only models with a weight larger than 0.01 are shown. All variables were scaled and so the effect sizes are comparable.", 
               row.names = F, 
               digits = 2, 
               escape = F) %>%
  kableExtra::add_header_above(c("effect sizes" = 5, " " = 3), escape = F) %>%
  kableExtra::kable_styling(font_size = 8) %>%
  kableExtra::group_rows("control capacity models", 1, nrow(cc_table)) %>%
  kableExtra::group_rows("superior probability models", nrow(cc_table) + 1, nrow(cc_table) + nrow(su_table)) %>%
  kableExtra::footnote(general = "intercept (int), degree (deg), asymmetry (asy), visitation strength (str).", 
                       general_title = "Terms: ", 
                       footnote_as_chunk = TRUE, 
                       threeparttable = TRUE)
```

```{r fig-species-level, fig.width=fig_sizes()[[2]]*2/3, fig.height=fig_sizes()[[1]], fig.cap="Density plot of the control capacity $\\phi$ of (a) plants and (b) pollinators. (c, d) Relationship between the most important variables in the models of control capacity. The plots show the values predicted by most parsimonious model for each response variable. The model included a random effect for the trophic guild and hence trends of plants and pollinators are shown separately. The invasive species are depicted with solid orange circles."}
drake::loadd(fig_control_capacity)
library(ggplot2)
fig_control_capacity[[2]] <- fig_control_capacity[[2]] +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank())
fig_control_capacity[[4]] <- fig_control_capacity[[4]] +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank())

# pdf("test.pdf", width =fig_sizes()[[2]]*2/3, height = fig_sizes()[[1]])
fig_control_capacity %>%
    cowplot::plot_grid(plotlist = ., rel_widths = c(1.21,1), align = "h")
# dev.off()
```

```{r}
drake::loadd(critical_sp_df)
crit_test <- critical_sp_df  %$%
    t.test(feasibility ~ critical, 
           alternative = "less", 
           conf.int = T)
```

We also found that critical species (those with a control capacity $\phi = 1$) have a larger impact on species coexistence as the structural stability of the network was considerably reduced when these species were removed from their communities ($p = `r sprintf('\\num{%s}', format(crit_test$p.value, digits = 2))`$; Figure \@ref(fig:fig-structural-stability); Figure \@ref(S-fig:fig-rho-sensitivity)). 
Although some pollinators had large values of control capacity, the group of critical species in every community was composed exclusively of plants. 

```{r fig-structural-stability, fig.width=fig_sizes()[[1]], fig.height=fig_sizes()[[1]]/2, fig.cap="Density plot of the structural stability of the communities after a focal species is removed. The structural stability after critical species have been removed (darker line) is considerable smaller than the average. To allow comparison across communities, the structural stability values were scaled within each network to have a mean of 0 and a standard deviation of one."}
drake::loadd(fig_structural_stability)
fig_structural_stability[[1]]
```

```{r correlation-calculations}
drake::loadd(sl_char_corr)
correlations <- sl_char_corr %>% 
  extract2("mean") %>%
  as.data.frame() %>%
  tibble::rownames_to_column() %>%
  dplyr::filter(!rowname %in% c("control_capacity", "superior"))
```

The control capacity of a species $\phi$ was only weakly correlated with commonly used centrality metrics. 
The Spearman correlation ranged between `r round(min(correlations$control_capacity), 2)` (with betweeness-centrality) and `r round(max(correlations$control_capacity), 2)` (with eigen-centrality). 
On the other hand, the probability of being a superior species $\sigma$ was slightly more similar to established centrality metrics. 
The Spearman correlation coefficient ranged between `r round(min(correlations$superior), 2)` (with eigen-centrality) and `r round(max(correlations$superior), 2)` (with degree; Figure \@ref(S-fig:fig-correlogram)). 

\R{testing-assumptions-results-line} We found that using visitation as a proxy for the strength of species interactions leads to similar results than those obtained using pollinator importance [regarded as an accurate measure of the pollination service to plants; Supporting Information Section \@ref(S-visitation-as-proxy); @neeman_framework_2009]. 
Importantly, we also found that structural stability is robust to incomplete sampling of interactions. 
We found a very strong agreement between results obtained using the complete empirical networks and those obtained by randomly removing interactions (Supporting Information Section \@ref(S-undersampling)). 
Despite removing rare interactions and species, the relative size of the minimum driver node-set, the superior species, and the relative rankings of control capacity were generally maintained. Remarkably critical species in the full network were also critical in the vast majority of rarefied networks. 

# Discussion

Our main goal was to understand the role that species play at both modifying the abbundance of the species they interact with and the state of the community as a whole. 
To achieve that goal we applied *structural controllability*, a field at the intersection between control and complex theory that allow us to obtain two key pieces of information: the *controllability* of a network and a species *control capacity*. 

ND is a measure of the extent to which network structure can be harnessed to drive the state of the community.

Empirical observations indicate that steering the state of some communities—for example during ecosystem restoration or invasive species removal—can be a very difficult task [@woodford_confronting_2016]. 
Despite the large number of empirical examples, to date there is no thoretical basis that explains this difficutlies. 
Here, we show that the *controllability* of a network provides a way to quantify this intrinsic difficulty of controlling an ecological community and the differences among them. 
The controllability of a network is given by the relative size of the minimum driver node-set, $n_D$. 
In other words, controllability is related to the smallest proportion of species whose abundances need to be directly managed in order to achieve full control of the community (to be able to steer the community to an arbitrary ecological state). 
We found that in the pollination networks from our dataset the median $n_D$ equals `r round(median(c_m$n_D),2)`. 
This value is fairly high when compared to several other complex systems in which structural controllability has been applied. 
For instance, in most social, power transmission, internet, neuronal, and even metabolic networks $0.1 < n_D < 0.35$ and, at least withing the biological realm, only gene regulation networks appear to achieve similar levels of controllability [@liu_controllability_2011]. 
Although these results indicate that fully controlling ecological networks might currently be out of reach for all but the smallest communities [@motter_networkcontrology_2015], structural controllability might provide solid theoretical explanation to the many difficulties encountered in the management and restoration of natural communities. 

Structural controllability might also offer novel means to compare ecological networks, particularly when exploring the relationship between network structure and stability. 
Even though all studied communities appear to be hard to control, we still found significant variation between them—the relative size of the minimum driver node set ranged between $n_D = `r round(min(c_m$n_D), 2)`$ and `r round(max(c_m$n_D), 2)`. 
Interestingly, we found that the controllability of a network is not related to their invasion status. 
Instead, we found that, despite our relatively small sample size, these differences in controllability may stem from differences in structure. 
Specifically, networks with a larger asymmetry between plant and pollinator species richness and with larger connectances were more likely to have higher values of $n_D$. 
In addition, we found that the $n_D$ of empirical networks was indistinguishable from that of network randomisations that roughly maintained the degree distribution, but was significantly different to those in which the patterns of dependence were broken. 
All together, these results suggest that network controllability is almost completely constrained by the patterns of species richness at each trophic guild and their degree distributions [@melian_complex_2002; @bluthgen_specialization_2007]. 
These two factors, in turn govern the asymmetric nature of mutual dependences-which constitute the foundations of structure and stability in mutualistic networks [@bascompte_asymmetric_2006; @memmott_tolerance_2004; @astegiano_robustness_2015]. 

Structural controllability not only can offer valuable insight at the community level, but, by measuring a species *control capacity*, here we show that it can also be used to better understand the role of individual species. 
The group of species that compose the minimum driver node-set $n_D$ is often not unique. 
This means that there are many species combinations with which it is possible to fully control a network
Each of these combinations represents a control configuration. 
Some species belong to these combinations more often that others. 
We call this property a species control capacity $\phi$. 
The higher a species control capacity, the higher the likelyhood that they would need to be directly managed to change (or maintain) the ecological state of their communities. 
A small fraction of species in each network (between `r round(pcrit_ran[1]*100)` and `r round(pcrit_ran[2]*100)`%) had a control capacity of $\phi = 1$. 
We call these *critical* species. 
Because critical species are driver in every single control configuration it is unlikely that any attempt to steer the community to a different state will be successful without directly managing the abbundances of these species. 
Interestingly, although the average control capacity of pollinators was higher than that of plants, the group of critical species was exclusively composed by plants. 

Because of the presumed relationship between central and keystone species, we expected control capacity to be somewhat correlated with some metrics of centrality. 
However, despite the influence that critical species might have into the state of the community, a large control capacity is not necessarly accompained by a large centrality. 
Indeed,  the correlation coefficients between control capacity and five different centrality metrics was low and both specialist and generalist species could play an important role at changing the abbundances of other species. 

Althogh control capacity was poorly predicted by centrality, we found that it was strongly related to a species contribution to nestedness and, to a smaller extent, the species strength. 
The species strength (the sum of visits that a species receivers or performs) quantifies how strongly a species interacts with its partners. 
Indirectly, it is also a reflection of the species' abundance, and therefore its relationship with control capacity can be explained by the fact that species with large populations are anticipated to have a larger effect in the community than less common species. 

The strong relationship between control capacity and nestedness is more revealing in particular because we also found that critical species play a major role at enabling the coexistence of other species in their community. 
Previous studies suggest that nestedness is key to the persistence of pollination networks as it minimises species competition—and therefore promotes species coexistence—and confers robustness to species extinctions in the community. 
Using two completely different approaches, our results suggest that species that are more likely to determine the state of the community might also be more likely to contribute the most at "maintaining the organization and diversity of their ecological communities", one of the hallmarks of keystone species [@mills_keystone-species_1993].

Invasive species have been previously found to exacerbate the asymmetries in their communities [@aizen_invasive_2008; bartomeus_contrasting_2008-1; @henriksson_strong_2016]. 
Although this might be reflected on differences both at the community and the species level, we found that invasive plants are not inherently different to their native counterparts [@emer_species_2016; @stouffer_how_2014]. 
Invasive plants, just like any other mutualist in our data set, tended to attain a high control capacity proportional to the degree to which they contribute to nestedness and interact strongly with other species. 
Nevertheless 
Previous studies have found that supergeneralists, like invasive species, play a central role in their networks (Vilà et al. 2009; Palacio, Valderrama-Ardila & Kattan 2016). 
XXXOur results take this one step further and indicate that dependence strength, rather than generalism or other metrics of centrality, is the factor that best explains the cascading effects a species could trigger on its community.

The structural controllability approach, just like classic centrality metrics is sensitive to the uncertainity associated with the sampling of ecological interactions. 
Our sensitivity analyses suggest that structural controllability is robust to at least two sources of uncertainity: when interactions are only sampled incompletly and when multiple metrics could be used used to quantify the strength of associations between species. 

Another common critique to structural controllability is that it is based on the premise that the system can be described using linear functional responses [@cowan_nodal_2012]. 
This is indeed a current limitation, as we know that ecological systems are often best described using different nodal dynamics. 
However, we are not discouraged by its application for three main reasons. 
First, it has been shown that when the parameters that describe the mechanisms of self-regulation are not independent from each other, as is ofthen the case in ecological networks, the principles of structuctural controllability can still be applied [@zhao_intrinsic_2015]. 
Second, although non-linear dynamics render structural controllability unsufficient to assure full control an ecological system, it is still a necessary step to achieve that goal. 
Finally, by accounting for network dynamics (even if in a simple way) it incorporates more ecological realism than classical centrality metrics and hence is more likely to provide useful information even in the extreme scenario in which the state of a community depends almost exclusively on nodal dynamics rather than on the topology of their interactions.

From an applied ecology perspective, @paine_note_1969 showed nearly 50 years ago that one species can dominate the state of its community. 
Structural controllability suggests that this situation might be the exception rather than the rule, at least when were interested in *managing* the state of 
community and not just on inducing a change. 
Our results also provide support to the idea that management approaches focused on ecosystem processes and interactions might be more effective than traditional single-species approaches [@harvey_bridging_2017]. 
A `r round(sum(crit$n_crit > 1)/nrow(crit)*100)`% of our communities contained more than one critical species. 
Approaches identify keystone species and ultimately prioritise species for conservation are still useful at predicting the consequences of single species removals or reintroductions [@pires_friendship_2017; @devoto_understanding_2012], but effective management and restoration of ecological communities is likely to require more than a ranking of species based on their traits or centrality.

<!-- Biggest lesson is that changing the state of the community in a requires concerted action by several species, not just changes in the abbundance of one species.  -->

<!-- Control theory is flexible and awknoledges that there are multiple ways to achieve changes in the state of the community.  -->
<!-- Managing the most central species might not be suficient or even required to achieve that goal.  -->

<!-- Even if full control is not possible or not desired we learnt that there are critical species, those that no matter what the management strategy will need to be managed if one wants effective control of the populations in the ecological community.  -->

<!-- Centrality species concept is limited because we onl -->


<!-- We propose structural controllbility as a metric that can be used to compare ecological systems both in a theoretical and applied context. -->

# References
