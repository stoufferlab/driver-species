---
title: "Working title: Ecological network control"
classoption: a4paper
csl: journal-of-ecology.csl
output: 
  bookdown::pdf_document2: 
    keep_tex: yes
    number_sections: false
toc: false
header-includes:
- \usepackage{geometry}
# - \geometry{right=3in,marginparwidth=2.5in}
- \usepackage{setspace}
- \usepackage{float}
- \usepackage{booktabs}
- \usepackage{caption}
- \usepackage{lineno}
- \usepackage{xr}
- \externaldocument[S-]{supp-info}
documentclass: artikel1
bibliography: references.bib
---

\doublespacing
\linenumbers

**E. Fernando Cagua^1^, Kate L. Wootton^1,2^, Daniel B. Stouffer^1^**

^1^ Centre for Integrative Ecology, School of Biological Sciences, University of Canterbury, Private Bag 4800, Christchurch 8041, New Zealand

^2^ Current address: Department of Ecology, Swedish University of Agricultural Sciences, Box 7044, SE-750 07 Uppsala, Sweden

**Author for correspondence:** Daniel Stouffer (daniel.stouffer@canterbury.ac.nz) - +64 3 364 2729 - Centre for Integrative Ecology, School of Biological Sciences, University of Canterbury, Private Bag 4800, Christchurch 8140, New Zealand

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, 
                      warning = FALSE)
options(xtable.comment = FALSE, 
        xtable.caption.placement = 'bottom',
        xtable.size = 'small',
        booktabs = TRUE)
```

\newpage

# Introduction

A major goal in ecological research is to understand the role that species play in the biotic environment.
Within community ecology, a complex-systems has led to the development of a variety analytical and simulation tools with which to understand the role of the role of species embedded in a network of interactions [@bascompte_assembly_2009; @stouffer_evolutionary_2012]. 
A particularly relevant dimension of any species' role is its ability to alter the abundance of other species in the community, since this impacts ecosystem function and biodiversity and might have knock down effects on other processes and services.
This ability is often referred as "keystoneness". 
A significant proportion of the network tools used to estimate species roles in this context relies on the assumption that there is a link between a species centrality—a relative ranking of its importance that stems from social network research—and its ability to alter other species' abundance. 
At first glance, this assumption makes sense. 
At the core of representing ecological communities as networks sits the idea that the abundance of a species also depends on the abundance of its neighbours (the species it interacts with) and, by extension, the abundance of its neighbours neighbours', and so on. 
More central species, by definition, are better connected and hence should be more likely to affect the abundance of other species in the network.

Though conceptually intuitive, the relationship between centrality and keystoness is largely phenomenological. 
On one hand, there is more than a dozen indices of centrality used in ecology. 
Chosing a particular metric can be a difficult task, especially because to date there are not clear methods to determine the suitability of an index to a particular application. 
Furthermore, recent studies have shown that definitions of keystoness based on centrality might not adequately predict the cascading extintions keystone species are ususally associated to. 
As a result, community ecology could benefit from an alternative, more mechanistically-grounded, approach to understand how species affect each other abbundance. 
Species abundances are also influenced by the dynamic relationships between nodes, and the mechanisms of self-regulation, however, community and population dynamics can be modeled in innumerable ways, and empirical support for one versus another is often still ambiguous. 
The alternative approach should acknowledge ecosystem dynamics, but without being overly dependent on the particular choices of how they are characterised.

Among the various possibilities, *control theory* appears to be a strong candidate [@isbell_human_2013]. 
Control theory is a widely studied branch of engineering used to determine and supervise the behaviour of dynamical systems [@motter_networkcontrology_2015]. 
It is inherently designed to deal with system feedbacks and its application has recently been expanded to complex networks [@liu_control_2016]. 
In correspondence with ecological questions, advances in this field have established a clear link between the structure of the network and the way nodes affect each other. 
Unlike centrality indices, however, this link is not based on a priori assumptions between network metrics and keystoness, instead on well-established advances in both dynamical and complex-systems theory <!--STOUFFER: Are we shooting ourselves in the foot since this isn't entirely true? That is, see comments from ELE about linearity and otherwise. CAGUA: How about this modified phrasing?-->.

Despite the apparent overlap, the concepts and approaches of control theory are not yet commonly applied in an ecological context. 
Possibly, this is in part because research on the control of complex networks is generally more concerned with the state of the system as a whole. 
This is in contrast with the ecological role concept, where the focus is on the nodes that compose the network.
At its fundamental level, control theory first determines whether a system is controllable or not; that is, it asks if a system can be driven to a desired state within a finite amount of time. 
Although the controllability of a network is a whole-system property, it has been recently shown that asking for the controllability of a complex-system is equivalent to finding a particular set of nodes. 
A set with which is possible to control the state of the whole network. 
Notably, this set of nodes is not always unique for a given network.
This implies that an examination of the distinct sets provides a means to connect nodes with its *general* ability to modify the system to which they belong. 

Here, we apply methods from control theory to an ecological problem and show how it can be used to gain insight into the role of species in an ecological network. 
Specifically, we outline the approach using a set of ten pairs of uninvaded and invaded plant-pollinator communities. 
We use invaded communities because there is strong empirical evidence showing that invasive species play an important role shaping the abundances of other species, and particularly in these ten networks [@lopezaraizamikel_impact_2007; @bartomeus_contrasting_2008-1]. 
This choice thus offers us an opportunity to explicitly contrast theoretical observations with empirical evidence.
First, grounded in the difficulties usually involved with invasive-species eradication and ecosystem restoration [@woodford_confronting_2016], we ask whether there are differences between the controllability of invaded and uninvaded networks. <!--STOUFFER: I'd remove the grounded in.... stuff, but that's just me.  CAGUA: I don't like it either. I tried removing but then it feels like this question is coming out of the blue.-->
Then we expand existing methods control theory to effectively link the *controllability* of a network with the role of particular nodes. 
We ask—from a control-theoretic perspective—whether there are key differences between species in the role they play at driving the population of other members of the community and identify the ecological factors related to these differences. 
Finally, we compare the proposed approach to current methods based on species centrality and show how these methods are indeed valuable but only paint a limited picture in regards to the "keystoneness" of a species.

# Methods

```{r load-metadata}
drake::loadd(metadata)
lop <- dplyr::filter(metadata, study == "lopezaraiza") %>% 
  dplyr::mutate(size = n_pla + n_pol) %$% size %>% summary() 
bar <- dplyr::filter(metadata, study == "bartomeus") %>% 
  dplyr::mutate(size = n_pla + n_pol) %$% size %>% summary() 
```

```{r prepare-graph-direction}
drake::loadd(en_direction)
# graph attributes
formatted_en_direction <- en_direction  %>%
  purrr::map(~ fancify_vertex_name(.)) %>%
  purrr::map(~ add_property(., element = "edge", attr_name = "color", 'TRUE ~ "black"')) %>%
  purrr::map(~ add_property(., element = "edge", attr_name = "label.color", 'TRUE ~ "black"')) %>%
  purrr::map(~ add_property(., element = "edge", attr_name = "label.font", 'TRUE ~ 2')) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "color", "TRUE ~ 'white'")) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "frame.color", "TRUE ~ 'black'")) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "size", "TRUE ~ 55")) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "label.cex", "TRUE ~ 1")) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "label.color", "TRUE ~ 'black'"))

formatted_en_direction[[1]] %<>%
  igraph::set_edge_attr("width", value = igraph::E(.)$weight * 0.5)
formatted_en_direction[[2]] %<>%
  igraph::set_edge_attr("width", value = 1)

direction_layout <- matrix(c(1,0,
                             2,0,
                             3,0,
                             1.5, 1,
                             2.5, 1), nrow = 5, ncol = 2, byrow = T)
```

```{r prepare-graph-structural}
drake::loadd(en_structural)

# format networks for plotting
formatted_en_structural <- en_structural %>%
  purrr::map(~ fancify_vertex_name(.)) %>%
  purrr::map(~ add_property(., element = "edge", attr_name = "color", 'TRUE ~ "black"')) %>%
  purrr::map(~ add_property(., element = "edge", attr_name = "lty", "control_type == 'a' ~ 1", "TRUE ~ 3")) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "color", "control_type == 'a' ~ 'white'", "TRUE ~ 'white'")) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "frame.color", "control_type == 'a' ~ 'black'", "TRUE ~ 'white'")) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "shape", "control_type == 'a' ~ 'circle'", "TRUE ~ 'square'")) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "size", "control_type == 'a' ~ 55", "TRUE ~ 45")) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "label.cex", "TRUE ~ 1")) %>%
  purrr::map(~ add_property(., element = "vertex", attr_name = "label.color", "TRUE ~ 'black'"))
```

```{r example-network-common-plotting-par}
plot_example_ntw <- function(x, ...){
  plot_examples(x, rescale = F, 
                frame = F, 
                margin = rep(0, 4), 
                edge.arrow.size = 0.4,
                edge.label.family = "sans", 
                vertex.label.family = "sans", ...)
}

```

We used ten paired pollination communities to apply the control theoretic approach.
Each community pair was composed of a community invaded by a plant and a community free of the invasive species. 
Four pairs correspond to natural or semi-natural vegetation communities in the city of Bristol, UK [@lopezaraizamikel_impact_2007]. 
These communities are comprised of `r lop[1]`--`r lop[6]` species (mean `r round(lop[4])`), and non-invaded plots were obtained by experimentally removing all the flowers of the invasive species *Impatients grandulifera*.
The other six pairs were obtained from lower diversity Mediterranean shrublands in Cap de Creus National Park, Spain [@bartomeus_contrasting_2008-1].
These communities are comprised of `r bar[1]`--`r bar[6]` species (mean `r round(bar[4])`); in contrast to the above, uninvaded communities were obtained from plots that had not yet been colonised by either of the invasive species *Carpobrotus affine acinaciformis* or *Opuntia stricta*. The structure of all these communities was defined by the pollinator visitation frequency, which has been shown to be an appropriate surrogate for interspecific effects in pollination networks [@vazquez_interaction_2005; @bascompte_asymmetric_2006]. 
Full details about the empirical networks, the implications of using visitation frequency to quantify the strength of the associations, and the sensitivity of the control theoretic approach to undersampling of the interactions can be found in the supplementary information section \@ref(S-empirical-networks), XX, and XX. 

The first step before applying methods of control theory is to construct a directed network that is able to provide an indication of the extent to which species affect each others abundance. 
In some ecological networks, establishing the directionality can be relatively straightforward, for example when links represent biomass transfer or energy flow [@isbell_human_2013]. 
In pollination networks, however, this directionallity is less obvious as both species can in theory benefit from the interaction. 
We overcome that obstacle by noting that the extent to which species *i* affects species *j* relative to the extent to which *j* affects *i* can be summarised by the interaction asymmetry [@bascompte_asymmetric_2006]. 
This asymmetry is given by $$a(i,j) = a(j,i) = \frac{\left | d_{ij}-d_{ji} \right |}{max\left ( d_{ij}, d_{ji} \right )},$$ where the dependence of plant *i* on pollinator *j*, *d~ij~*, is the proportion of the visits from pollinator *j* compared to all pollinator visits to plant *i*. 
Previous research has shown that mutualistic interactions are often highly asymmetric in natural communities; in other words, if a plant species is largely dependent on a pollinator species, then that pollinator tends to depend rather weakly on the plant (or vice versa). 
We then create a directed link between species *i* and *j* when $d_{ij}-d_{ji} \geq 0$ to establish the most likely direction of control between a species pair (Figure \@ref(fig:fig-example-networks)a). 
By basing the direction of the links on the asymmetry of their dependence, we are able to generate a network that is consistent with the dynamics of the community while satisfyingh the requirements of structural controllability. 

```{r fig-example-networks, fig.width=3.5, fig.height=2.6, fig.cap="(a) To establish the direction of control we start with a weighted visitation network (right side). In this network, the width of the links correspond to the frequency of visitation. We then calculate the dependencies between species pairs and create a directed network (left side) in which the direction of the links correspond to the direction of the assymetry of their dependence. For instance, the population of plant $p_1$ is likely to be affected by the population of pollinator $a_1$ to a larger extent that the population of $a_1$ depends on $p_1$ because $a_1$ interacts more strongly with other species in the community; hence the direction of control between these two species can be simplyfied with a directed link from $a_1$ to $p_1$. (b) A system is structurally controllable if there are no inaccessible links or dilations. The network on the top left is not controllable because node $x_3$ is inaccessible from the input node $u_1$ in the system. The network in the bottom left is not controllable because there is a dilation in which node $x_2$ is being used to control two nodes simultaneously. Both systems can be made controllable by adding an extra input node (right panel)."}
out_pdf <- F
height1 <- 0.9
height2 <- 1.5

if(out_pdf) pdf("test.pdf", width = 3.5, height = height1 + height2 + 0.2, paper='special') 

c(01,10,12,11,91,
  90,13,12,14,91, 
  80,80,80,80,80, 
  02,20,28,21,93,
  22,24,28,25,93,
  23,26,28,27,93) %>%
  dplyr::dense_rank() %>%
  matrix(nrow = 6, ncol = 5, byrow = T) %>%
  layout(heights = c(height1 * 0.25, height1 * 0.75, height1 * 0.2, height2 * 0.1, height2 * 0.45, height2 * 0.45),
         widths = c(0.2, 1, 0.05, 1, 0.2))
par(mar = rep(0,4), bg = "white")

## LABELS
# 01
standalone_text("(a)", y = 0.75)
# 02
standalone_text("(b)", y = 0.75)
## FIGURE A
# 10
standalone_text("visitation network", y = 0.25, adj = c(0.5,0), font = 2)
# 11
standalone_text("direction of control", y = 0.25, adj = c(0.5,0), font = 2)
# 12
standalone_vline(lty = 2)
# 13-14
for(i in 1:length(formatted_en_direction)){
  l <- rescale_layout(direction_layout, xlim = c(-1, 1) * 1.75, ylim = c(-0.6, 0.7))
  plot_example_ntw(formatted_en_direction[[i]], layout = l)
}
## FIGURE B
# 20
standalone_text("not controllable", y = 0.25, adj = c(0.5,0), font = 2)
# 21
standalone_text("controllable", y = 0.25, adj = c(0.5,0), font = 2)
# 22
standalone_text("inaccessible\nnode", srt = 90)
# 23
standalone_text("dilation", srt = 90)
# 24-27
for (i in 2:length(formatted_en_structural)){
  types <- igraph::V(formatted_en_structural[[i]])$type == dplyr::first(igraph::V(formatted_en_structural[[i]])$type)
  l <- igraph::layout_as_bipartite(formatted_en_structural[[i]], types) %>%
    rescale_layout(xlim = c(-1.75, 1.75), ylim = c(-0.6, 0.6))
  plot_example_ntw(formatted_en_structural[[i]], layout = l)
}
# 28
standalone_vline(lty = 2)
## DIV LINES
# 80
standalone_hline()

if(out_pdf) dev.off()
```

After constructing the directed network, we can now calculate the controllability of the different networks and investigate wether there are differences between invaded and uninvaded communities. 

## Controllability

A system is said to be controllable if it is possible to steer it from an initial to an arbitrary final state within finite time [@kalman_mathematical_1963]. 
A simple dynamic system can be described by $\frac{dx}{dt} = Ax + Bu(t)$, where the change of its state over time ($\frac{dx}{dt}$) depends on its current state *x* (for example, the species' abundances), an external time-varying input *u(t)* (the control signal), and two matrices *A* and *B*, which encode information about the network structure and how species respond to external inputs, respectively. 
In classic control theory, determining wether this system is controllable or not can easily be achieved by checking that its controllability matrix $R= [ \begin{matrix}B & AB & A^{2}B & ...& A^{n-1}B\end{matrix} ]$ has full rank. 
In complex systems, however, employing this rank condition, or numerical approximations of it, is unfeasible because it is hard to fully parameterize *A* and *B* (either the weights of the links change over time or because they are difficult to measures). 
Here we use an approach based on the structural controllability theorem [@lin_structural_1974], which assumes that we are confident that the elements of *A* and *B* have either non-zero or zero values (there is an interaction or not), but that we less sure about the precise magitude of the non-zero values. 
Using this structural approach we can find out the controllability of a system under almost all non-zero parameter realisations.
In addition, a graphical interpretation of the structural controllability theorem enables us to translate the control problem into a topological one: a network is controllable if there are no inaccessible nodes—nodes without incoming links—or dilations—*expansions* of the network (Figure \@ref(fig:fig-example-networks)b; supplementary information section \@ref(S-structural-controllability)).

We are often able to estimate *A* in ecological networks, as it represents the interactions between species. 
Part of the control problem resides on estimating a supportable estimation of *B*, which represents the links between external inputs and species. 
Naively, any ecological community (and any system for that matter) could be controlled if we control the state of every species independently. 
Such approach is typically unpractical. 
We are instead interested in finding a minimum driver node set (effectively finding *B*) with which to make the system controllable. 
However, a brute force search of this minimum driver node set is computationally prohibitive for most networks as it involves the evaluation of $2^N$ different controllability matrices. 
We employ a recently developed approach that shows that the control problem of finding the minimum driver node set can be mapped into a purely graph theoretic problem: maximum matching [@liu_controllability_2011; @liu_control_2016].

Maximum matching is a widely studied topic in graph theory and is commonly used in multiple applications, from dating apps and wireless communications to organ transplant allocation and peer to peer file sharing. 
A matching in an unweighted directed graph is defined as a set of links that do not share a common start or end nodes. 
A node is said to be superior if it is at the beginning of a matched link and called matched if it is at the end. 
Finally, the largest possible matching is called maximum matching. 
These definitions, however, offer little insight about how maximum matching is related to structural controllability. 
The key is to note that these definitions imply that a matched node can have only one matched link pointing to it, and similarly a superior node can have at most one link leaving from it. 
The result is that a matching can actually be decomposed into a set of paths that reveal how a control signal can flow across the links in a network to reach every node that compose it. 
And so, as recently shown [@liu_controllability_2011], the minimum driver node set corresponds exactly to the *unmatched* nodes, those that are not controlled by other nodes in the network.

The technical details of the algorithm we use to find a maximum matching in a network can be found in the supplementary information section \@ref(S-one-maximum-matching).

## Differences between invaded and uninvaded networks

Our first main objective is to investigate whether the controllability of a community is associated to invasion status or not. 
Finding out exactly, how difficult is to control a network depends strongly on the particularities of the desired control trayectory as well as the dynamical relationpip between nodes. 
However, we are interested in understanding the controllability of a network in a more general sense, such that it can be applied even when the precise control scenario is known only incompletely. 
We instead employ an indicator that follows from our approach: the size of the minimum driver node set. 
This simple metric provides general indication of how difficult controlling a network might be, as systems that require a large number of external inputs to be fully controlled are intuitively more difficult or costly to manage. 
Specifically, following the structural controllability literature, we use the size of the minimum driver node set relative to the total number of nodes $n_D = \frac{D}{S}$ as a measure of the extent to which the network structure can be harnessed to control the community.
In an ecological context, external inputs can be thought of as management interventions that modify the abbundance of a particular species. 
For instance, achieving full control in a "network" in which species do not interact at all is relatively difficult as we would require an intervention for every single species. 
Conversely, the structure of a linear trophic chain can be harnessed to achieve full control using just one intervention targeted the top species; the control signal would then cascade trough the trophic levels and reach other species in the community. 

After finding the minimum driver node set in each of our networks we want to test whether invasion status or other predictors are correlated to this metric of controllability. 
We therefore use a set of generalised linear models (with binomial error structure) to investigate the effect of invasion status while also including covariates related to species richness, since one might naively expect to see a negative relationship between richness and controllability [@menge_indirect_1995]. 
These covariates included the total number of species, plant richness, pollinators richness, the ratio of plant to pollinator richness, the link density (connectance), and the study site (as a two-level factor). In addition, we also explored whether real networks differ in their architecture from random ones in a concerted way; further details about this procedure can be found in the supplementary information section \@ref(S-randomisations).

## Species roles

Our second key question is related to how species differ in their ability to drive the population dynamics of the community. 
Ecologically, these differences are relevant because resources and data are limited, and therefore full control is unfeasible. 
We are mostly interested in two specific aspects.
First how species differ in their relative , second, how species 


is management interventions should be focused on the set of species that might provide the largest impact. 
While calculating the size of the minimum drive node set can measure the controllability of an ecological community, it does not provide information about the role that particular species play. 





Moreover, maximum matchings in a network are often not unique, and each maximum matching indicates unique paths that can potentially be used to control the network. 
We harness this property and use a network's complete set of maximum matchings to characterise each species' relative importance in driving the state of the community. 
One possibility is to characterise a species by the frequency *f~D~* with which it is classified as a driver node within this set of matchings.
However, the profile of our networks indicates that a large proportion of species were classified as driver nodes because of external interventions required to achieve **full** controllability and not because they influence the abundance of other species (Supporting Information S2).
Furthermore, the precise role of driver nodes is more ambiguous when full control is unfeasible or undesired—often the case in ecological settings.
We therefore also calculate the frequency *f~S~* with which a species is classified as a superior node since this is the frequency with which they form part of possible control paths.

Most commonly, structural controllability assumes unweighted networks—links exist or not, and hence *f~D~* and *f~S~* can be calculated by computing all possible maximum-cardinality matchings. 
However, we take the link weights into account when calculating the matchings here because the weights can reveal significant ecological patterns and processes that might be undetectable in unweighted networks [@Scotti2007; @Tylianakis2007; @Vazquez2007; @Kaiser-Bunbury2010a]. 
Additionally, species *A* may interact with both species *B* and *C* but depends strongly on *B* and only weakly on *C*. 
Intuitively, a management intervention designed to indirectly modify the abundance of species *A* is more likely to succeed if the abundance of *B*, rather than *C*, is directly controlled.
A complication of including the interaction weight when calculating the maximum matching, however, is that empirical interaction strengths are to some extent stochastic and depend on proximate factors such as sampling method and intensity [@Gibson2011].
We overcome this issue by calculating all maximal cardinality matchings and then ranking them by their matching weight. 
By following this approach, we effectively give priority to the species that participate in the pathways that potentially have the largest impact on the community while acknowledging the limitations associated with sampling and its potential restrictions [@Jordano2016]. 

Our second key question was related to how species differ in their ability to drive the population dynamics of the community. 
To quantify this importance, we computed all maximal cardinality matchings in each network. 
We then calculated the frequency with which each species *i* was a driver (*f~D~*) or a superior node (*f~S~*) in the set of matchings that had a matching weight greater or equal to 0.8 times the weight of the maximum matching. 
We selected this threshold as it provided a high agreement between networks quantified by visitation and pollination efficiency as well as between our weighting/directionality assumptions; however, the choice of this threshold had a negligible impact on any results (Supporting Information S8).
Details about the computational procedure to find all maximal cardinality matchings of a network can be found in Supporting Information S1 and Figure S2.


# References
