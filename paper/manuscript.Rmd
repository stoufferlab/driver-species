---
title: "driver species paper"
output: pdf_document
---

**how is the control species number influenced by network structure?**

Using both Bartomeus and Lopezaraiza dataset
```{r, echo=FALSE}
library(ggplot2)
library(magrittr)
# load utility functions
nn <- list.files("../code/functions", full.names = TRUE) %>% lapply(source)

my_theme <- theme_classic() + theme(legend.position = "none", text = element_text(family = "Times"), axis.title.x = element_text(vjust = -0.7), axis.title.y = element_text(vjust = 1.5)) 
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
n_driver <- read.csv("../data/n_driver_species.dat")
random_n <- read.csv("../data/random_n_driver.csv")

n_control <- n_driver %>%
	dplyr::select(-keep) %>%
	tidyr::separate(type, c("type", "keep"), "\\.", remove = T)

random_n_z <- random_n %>% 
	dplyr::group_by(net, type, keep, method) %>%
	dplyr::summarise(n_driver_u = mean(n_driver, na.rm = T),
									 n_driver_sd = sd(n_driver, na.rm = T)) %>%
	dplyr::full_join(n_control) %>% 
	dplyr::group_by() %>%
	dplyr::mutate(n_driver_z_score = (n_driver - n_driver_u)/n_driver_sd) 

random_n_z %>% 
	ggplot(aes(x  = as.character(interaction(type, keep)), y = n_driver_z_score)) +
	geom_rect(ymin = -2, ymax = 2, xmin = -1, xmax = 10, fill = "grey90") +
	geom_hline(yintercept = 0, size = 0.4) +
	geom_vline(xintercept = seq(1.5, 5.5), linetype = 2) +
	geom_boxplot(aes(fill = method)) +
	scale_fill_discrete(name = "randomisations\nmantain\ndegree of", labels= c("plants", "pollinators", "both")) + 
	my_theme + 
	xlab("link structure scheme") +
	ylab("standard score") +
	theme(legend.position = "right",
				axis.line.x = element_blank(), axis.ticks.x = element_blank())
```

\newpage

**what's the role of the dependency?**

Using dataset by Ballantune to demonstrate congruency between visitation and effective pollination dependency.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
random_dir_n <- read.csv("../data/random_dir_n_driver.csv") 

random_dir_n %>% 
	dplyr::mutate(type = "weight") %>%
	dplyr::group_by(net, type, keep) %>%
	dplyr::summarise(n_driver_u = mean(n_driver, na.rm = T),
									 n_driver_sd = sd(n_driver, na.rm = T)) %>%
	dplyr::inner_join(n_control) %>% 
	dplyr::group_by() %>%
	dplyr::mutate(n_driver_z_score = (n_driver - n_driver_u)/n_driver_sd) %>% 
	ggplot(aes(x  = as.character(interaction(type, keep)), y = n_driver_z_score)) +
	geom_rect(ymin = -2, ymax = 2, xmin = -1, xmax = 10, fill = "grey90") +
	geom_hline(yintercept = 0, size = 0.4) +
	geom_vline(xintercept = seq(1.5, 2.5), linetype = 2) +
	geom_jitter(position = position_jitter(height = 0), shape = 21) +
	geom_boxplot(fill = "white", alpha = 0.5) +
	scale_fill_discrete(name = "randomisations\nmantain\ndegree of", labels= c("plants", "pollinators", "both")) + 
	my_theme + 
	xlab("link structure scheme") +
	ylab("standard score") +
	theme(legend.position = "right",
				axis.line.x = element_blank(), axis.ticks.x = element_blank())
```

\newpage

**finally what makes a species relevant from management, and how invasive species fit there**?

exploring these and other factors related to especialization

```{r, echo=FALSE, warning=FALSE, message=FALSE, cache=TRUE}
library(grid)
library(gridExtra)

folder <- "../data/redundancy/node/"
node_redundancy <- list.files(folder, full.names = TRUE) %>%
    plyr::ldply(function(x, name){
        y <- read.csv(x) 
        info <- basename(x) %>% 
            stringr::str_sub(end = -5) %>% 
            stringr::str_split("_") %>% 
            unlist()
        y %>%
            dplyr::mutate(net = info[[1]],
                                        type = info[2],
                                        keep = info[3])
    }) 

nr_sum <- node_redundancy %>%
	dplyr::mutate(type = interaction(type, keep)) %>%
	dplyr::group_by(net, type, robustness) %>%
	dplyr::summarise(freq = n()) %>%
	dplyr::group_by(net, type) %>%
	dplyr::mutate(n_species = sum (freq)) %>%
	dplyr::group_by() %>%
	dplyr::mutate(prop = freq / n_species, 
								type = as.character(type), 
								robustness = as.character(robustness))

net <- list.files("../data/networks/", full.names = TRUE) %>%
    lapply(readRDS)
names(net) <- list.files("../data/networks/", full.names = FALSE) %>%
    stringr::str_split("\\.") %>% lapply(`[`, 1) %>% unlist ()

node_redundancy %<>% 
	plyr::ddply("net", function(x){
		this_net <- net[[dplyr::first(x$net)]] %>%
	# select only the largest connected component of the network
			keep_largest_component()
		nodes <- igraph::V(this_net)[x$n]$name
		x %>%
			dplyr::mutate(node = nodes)
	}) %>% dplyr::tbl_df()

deg_strength <- plyr::ldply(net,function(x){
	degree <- igraph::degree(x)
	m <- igraph::as_adjacency_matrix(x, attr = "weight", sparse = F)
	m[m == 0] <- NA 
	m_int_strength <- apply(m, 1, mean, na.rm = T)
	s_int_strength <- apply(m, 1, sum, na.rm = T)
	ncont <- igraph::as_incidence_matrix(x, 
														types = igraph::V(x)$type == "pla") %>%
		nestedcontribution() %>% dplyr::add_rownames("node")
	data.frame(node = names(degree), 
						 degree = degree, 
						 m_int_strength = m_int_strength,
						 s_int_strength = s_int_strength) %>%
		dplyr::full_join(ncont)
}) %>% dplyr::rename_("net_name" = ".id")

net_info <- read.csv("../data/ntw_info.csv")

net_info %<>%
	dplyr::mutate(ratio_pol_pla = n_pol/n_pla)

folder <- "../data/maximum_matchings_summary/" 
files <- list.files(folder)
node_mm <- plyr::adply(files, 1, function(x){
	read.csv(file.path(folder, x)) %>%
		dplyr::mutate(net = unlist(stringr::str_split(x, "_"))[1],
									type = unlist(stringr::str_split(x, "_"))[2], 
									keep = unlist(stringr::str_split(x, "_"))[3],
									batch = unlist(stringr::str_split(x, "_"))[4])
}) %>%
	dplyr::select(-X1) %>%
	dplyr::group_by(net, type, keep, node) %>%
	dplyr::summarise(freq = sum(freq))

ranked_mm <- node_mm %>%
	dplyr::filter(!is.na(freq)) %>%
	dplyr::group_by(net, type, keep) %>%
	dplyr::mutate(r = rank(freq, ties.method = "random"),
								f_f = freq/max(freq), 
								type.keep = as.character(interaction(type, keep)))  %>%
	dplyr::rename(net_name = net)

invasive_sp <- data.frame(node = c("p_4", "p_25"), invs.species = TRUE)

ranked_with_inv <- 
	ranked_mm %>% 
	dplyr::group_by() %>%
	dplyr::full_join(invasive_sp) %>% 
	dplyr::full_join(net_info)

imp <- ranked_with_inv %>%
	dplyr::full_join(deg_strength) %>%
	dplyr::filter(!is.na(type.keep), 
								type == "weight",
								keep == "A" | keep == "all") %>%
	tidyr::separate(node, into = c("categ", "number"), sep = "_", remove = F)

inv <- imp %>% dplyr::filter(!is.na(invs.species))

p1 <- imp %>%
	ggplot(aes(x = m_int_strength, y = f_f)) +
	geom_point(aes(fill = categ),
						 shape = 21, 
						 alpha = 0.5) +
	scale_shape_manual(values = c(21, 22)) +
	facet_wrap(~type) +
	geom_smooth(aes(colour = categ, fill = categ), 
							family = "binomial", method = "gam", colour = "grey10") +
	geom_point(data = inv, fill = "red", size = 2.5, shape = 21) +
	my_theme +
	xlab("mean interaction strength") +
	ylab("species frequency\nin control sets") +
	scale_color_discrete(name = "", labels = c("pollinators", "plants")) +
	scale_fill_discrete(name = "", labels = c("pollinators", "plants")) +
	theme(legend.position = "right", strip.background = element_blank())

p2 <- imp %>%
	ggplot(aes(x = degree, y = f_f)) +
	geom_point(aes(fill = categ),
						 shape = 21, 
						 alpha = 0.5) +
	scale_shape_manual(values = c(21, 22)) +
	facet_wrap(~type) +
	geom_smooth(aes(colour = categ, fill = categ), 
							family = "binomial", method = "gam", colour = "grey10") +
	geom_point(data = inv, fill = "red", size = 2.5, shape = 21) +
	my_theme +
	xlab("degree") +
	ylab("species frequency\nin control sets") +
	scale_color_discrete(name = "", labels = c("pollinators", "plants")) +
	scale_fill_discrete(name = "", labels = c("pollinators", "plants")) +
	theme(legend.position = "right", strip.background = element_blank())


p3 <- imp %>%
	ggplot(aes(x = nestedcontribution, y = f_f)) +
	geom_point(aes(fill = categ),
						 shape = 21, 
						 alpha = 0.5) +
	scale_shape_manual(values = c(21, 22)) +
	facet_wrap(~type) +
	geom_smooth(aes(colour = categ, fill = categ), 
							family = "binomial", method = "gam", colour = "grey10") +
	geom_point(data = inv, fill = "red", size = 2.5, shape = 21) +
	my_theme +
	xlab("contribution to nestedness") +
	ylab("species frequency\nin control sets") +
	scale_color_discrete(name = "", labels = c("pollinators", "plants")) +
	scale_fill_discrete(name = "", labels = c("pollinators", "plants")) +
	theme(legend.position = "right", strip.background = element_blank())

grid.arrange(p1, p2, p3, ncol = 1)
```

