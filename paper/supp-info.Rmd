---
title: "Ecological network control"
subtitle: "Supplementary Information"
author: "Fernando Cagua, Kate L. Wootton, Daniel B. Stouffer"
classoption: a4paper
csl: journal-of-ecology.csl
documentclass: artikel1
output: 
  bookdown::pdf_document2: 
    keep_tex: yes
    toc: false
header-includes:
  - \usepackage{booktabs}
  - \usepackage{setspace}
bibliography: references.bib
---

\renewcommand\thefigure{S\arabic{figure}}    
\setcounter{figure}{0}   

\renewcommand\thetable{S\arabic{table}}    
\setcounter{table}{0}   

\renewcommand{\thesection}{S\arabic{section}}
\setcounter{section}{0}

\onehalfspacing

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, 
                      warning = FALSE)
```

# Characteristics of the epirical networks {#empirical-networks}

```{r}
drake::loadd(metadata)
drake::loadd(network_properties)

net_prop <- metadata %>%
	dplyr::mutate(n_s_t = n_pla + n_pol) %>%
	dplyr::select(-n_pla, -n_pol) %>%
	dplyr::inner_join(network_properties, by = "net_name")

```

The networks studied had species richness ranging between `r min(net_prop$n_s_t)` and `r max(net_prop$n_s_t)` when considering only the largest component in each network). 
As shown by the network asymmetry *AS* [@bluthgen_specialization_2007], the networks had a low ratio of plants to pollinators overall. 
Furthermore, the networks had relatively low levels of nestedness [when measured using the quantitative version of the NODF index; @almeida-neto_straightforward_2011]. Details for each network can be found in the Table \@ref(tab:table-network-properties).

```{r table-network-properties, results = "asis", sanitize = FALSE}

net_prop %>%
	dplyr::select(-net_name, -count, -net) %>%
	dplyr::filter(study != "ballantyne") %>%
	dplyr::arrange(study, site, inv) %>% 
	dplyr::mutate(invader = dplyr::case_when(
				 	invader == "car" ~ "\\textit{Carpobrotus affine}",
				 	invader == "op" ~ "\\textit{Opuntia stricta}",
				 	invader == "imp" ~ "\\textit{Impatients grandulifera}",
				 	TRUE ~ "—"
				 ),
				 invader = dplyr::if_else(inv, invader, "—")) %>%
	dplyr::mutate(site = rep(1:n_distinct(site), each = 2),
				 inv = dplyr::if_else(inv, "yes", "no"),
				 study = dplyr::case_when(
				 	study == "bartomeus" ~ "Cap de Creus, Spain",
				 	TRUE ~ "Bristol, United Kingdom"
				 )) %>% 
  dplyr::select(site, invader, n_sp, n_pla, n_pol, connectance, web.asymmetry, weighted.NODF, study) %>%
  dplyr::rename_(
    # "$R$" = "n_s_t",
					"$n_p$" = "n_pla",
					"$n_a$" = "n_pol",
					"location" = "study",
					"$n_s$" = "n_sp",
					"$c$"= "connectance", 
					"NODF" = "weighted.NODF",
					# "$\\bar{a}$" = "interaction.strength.asymmetry",
					"$AS$" = "web.asymmetry") %>% 
  knitr::kable(escape = FALSE, 
               booktabs = TRUE, 
               digits = 2, 
               linesep = c("", "\\addlinespace"),
               caption = "Properties of the analysed plant-pollinator communities. Here show the number of species ($n_s$), the number of plants ($n_p$), the number of pollinators ($n_a$), the network connectance ($c$), the network asymmetry ($AS$), and the network nestedness (NODF index). All properties correspond to the network's largest component. British networks were assembled by Lopezaraiza-Mikel et al. (2007), Spanish were networks assembled by Bartomeus et al. (2008).")
```

# Structural controllability {#structural-controllability}

Structural controllability avoids the limitation of not knowing the exact values of the matrices *A* and *B*. 
The graphical interpretation of structural controllability can be summed up in two conditions for controllability: A system is controllable if there 


The overall objective of control theory is to be able to steer a system from one state to another in finite time. 
However, in complex systems like ecological communities, the large number of nodes and interactions as well as their non-linear dynamics render its control extremely challenging.
On one theoretical extreme, for instance, any ecological community could be fully controlled if we control the state of every species independently. 
On another, the mechanisms of self-regulation and the multiple feedback cycles found in ecological communities mean it is also theoretically possible to control the whole community by directly modifying the state of just a *single* species [@Cowan2012; @Markovsky2013]. 
Although mathematically correct, neither of these options are practical in real-world applications: the first because it is infeasible to design and implement interventions that modify the abundance of every single species in a community, and the second because the control signal might require unreasonably large amounts of time, energy, or unattainable rapid changes on the state [@Yan2012; @Motter2015].
Here we explore an intermediate point between these two trivial solutions.

In particular, we leverage the principle of species interdependence to find an intermediate set of *driver nodes* to control the network [@Liu2016]. 
When we focus on net interspecific effects, it is possible to identify a minimum number of nodes the control of which can theoretically drive the state of every other node in the network to a desired configuration. 
Conveniently the information necessary to determine this minimum number of driver nodes *D* is fully contained in the network structure [@Kalman1963; @Liu2011; @Motter2015]. 
Such a system can be described by $\frac{dx}{dt} = \mathbf{A}x + \mathbf{B}u(t)$, where the change of its state over time ($\frac{dx}{dt}$) depends on its current state *x* (for example, the species' abundances), an external time-varying input *u(t)* (the control signal), and two matrices *A* and *B*, which encode information about the network structure and how the species respond to the external input, respectively. 
If *S* is the number of species in the community, the matrix **A** has size $S \times S$ whereas the matrix **B** has size $S \times D$.

The goal of structural controllability, which we employ here, is to use the information contained in **A** to generate a supportable estimate of **B** (and by extension *D*).
This focus allows us to gain insight of the inherent controllability of a network, and the roles of the species that compose it, without being overly dependent on the particular choices of how the system dynamics are modelled or characterised. 
The trade-off of our approach is that, because of the assumption of linearity, structural controllability alone does not allow us to fully design the time-varying control signal *u(t)* that can drive the system from one particular equilibrium to another. 
Nevertheless, the lessons gained when assuming linearity---at both the network and the species level---are a prerequisite for eventually understanding nonlinear control [@Liu2011; @Liu2016]. 



**Add info about cacti. Inaccessible nodes and dilations.**

# Maximum matching 

Our approach to find the minumum number of driver nodes relies on finding maximum matchings. 
We start with a directed network in which the direction of the link represents the direction of control (Figure \@ref(fig:fig-direction-of-control)a). 
We then construct an alternative representation of the directed network in which each node of the directed network is represented by two nodes that indicate their outgoing and incoming links respectively (Figure \@ref(fig:fig-direction-of-control)b). 
Finding a maximum matching in this alternative representation is equivalent to finding the largest possible set of edges in which one node on the left-hand side is connected to at most one node on the right-hand side. 
To find the maximum matching we use the push-relabel algorithm implemented in `max_bipartite_matching` in the R package igraph 1.0.1 [@Csardi2006a]. 
Once we have the matching (shown in the Figure \@ref(fig:fig-direction-of-control)b) it is then easy to identify the roles of each node in this representation: nodes on the left-hand side that are connected to a matched (purple) link are superior while those connected to a matched link on the right-hand side are matched. 
This information can then be mapped back to the original representation to identify the control paths and the driver nodes in the network (Figure \@ref(fig:fig-direction-of-control)c). 
Figure \@ref(fig:fig-direction-of-control)d--f illustrate this approach for a network with bidirectional links.

## Finding a single maximum matching {#one-maximum-matching}

## Finding all possible maximum matchings

## Finding all possible minimum driver node sets

# Empirical vs. random expectation of controllability {#randomisations}

# References
