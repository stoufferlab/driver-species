---
title: "Ecological network control"
subtitle: "Supplementary Information"
author: "Fernando Cagua, Kate L. Wootton, Daniel B. Stouffer"
classoption: a4paper
csl: journal-of-ecology.csl
documentclass: artikel1
output: 
  bookdown::pdf_document2: 
    keep_tex: yes
    toc: false
header-includes:
  - \usepackage{booktabs}
  - \usepackage{setspace}
  - \usepackage{xr}
  - \externaldocument[M-]{manuscript}
bibliography: references.bib
---

\renewcommand\thefigure{S\arabic{figure}}    
\setcounter{figure}{0}   

\renewcommand\thetable{S\arabic{table}}    
\setcounter{table}{0}   

\renewcommand{\thesection}{S\arabic{section}}
\setcounter{section}{0}

\doublespacing

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, 
                      warning = FALSE)
```

# Characteristics of the epirical networks {#empirical-networks}

```{r}
drake::loadd(metadata)
drake::loadd(network_properties)

net_prop <- metadata %>%
	dplyr::mutate(n_s_t = n_pla + n_pol) %>%
	dplyr::select(-n_pla, -n_pol) %>%
	dplyr::inner_join(network_properties, by = "net_name")

```

The networks studied had species richness ranging between `r min(net_prop$n_s_t)` and `r max(net_prop$n_s_t)` when considering only the largest component in each network). 
As shown by the network asymmetry *AS* [@bluthgen_specialization_2007], the networks had a low ratio of plants to pollinators overall. 
Furthermore, the networks had relatively low levels of nestedness [when measured using the quantitative version of the NODF index; @almeida-neto_straightforward_2011]. Details for each network can be found in the Table \@ref(tab:table-network-properties).

```{r table-network-properties, results = "asis", sanitize = FALSE}

net_prop %>%
	dplyr::select(-net_name, -count, -net) %>%
	dplyr::filter(study != "ballantyne") %>%
	dplyr::arrange(study, site, inv) %>% 
	dplyr::mutate(invader = dplyr::case_when(
				 	invader == "car" ~ "\\textit{Carpobrotus affine}",
				 	invader == "op" ~ "\\textit{Opuntia stricta}",
				 	invader == "imp" ~ "\\textit{Impatients grandulifera}",
				 	TRUE ~ "—"
				 ),
				 invader = dplyr::if_else(inv, invader, "—")) %>%
	dplyr::mutate(site = rep(1:n_distinct(site), each = 2),
				 inv = dplyr::if_else(inv, "yes", "no"),
				 study = dplyr::case_when(
				 	study == "bartomeus" ~ "Cap de Creus, Spain",
				 	TRUE ~ "Bristol, United Kingdom"
				 )) %>% 
  dplyr::select(site, invader, n_sp, n_pla, n_pol, connectance, web.asymmetry, weighted.NODF, study) %>%
  dplyr::rename_(
    # "$R$" = "n_s_t",
					"$n_p$" = "n_pla",
					"$n_a$" = "n_pol",
					"location" = "study",
					"$n_s$" = "n_sp",
					"$c$"= "connectance", 
					"NODF" = "weighted.NODF",
					# "$\\bar{a}$" = "interaction.strength.asymmetry",
					"$AS$" = "web.asymmetry") %>% 
  knitr::kable(escape = FALSE, 
               booktabs = TRUE, 
               digits = 2, 
               linesep = c("", "\\addlinespace"),
               caption = "Properties of the analysed plant-pollinator communities. Here show the number of species ($n_s$), the number of plants ($n_p$), the number of pollinators ($n_a$), the network connectance ($c$), the network asymmetry ($AS$), and the network nestedness (NODF index). All properties correspond to the network's largest component. British networks were assembled by Lopezaraiza-Mikel et al. (2007), Spanish were networks assembled by Bartomeus et al. (2008).")
```

# Structural controllability {#structural-controllability}

Structural controllability avoids the limitation of not knowing the exact values of the matrices *A* and *B*. 
Using structural controllability controllability can be boiled down to two conditions: a system is controllable if there are no inaccessible nodes or dilations. A node is inaccessible if there are no directed paths between it and the input nodes. "Dilations are subgraphs in which a small subset of nodes attempts to rule a larger subset of nodes. In other workds there are more 'subordinates' than 'superiors'" [@liu_control_2016].

The goal of structural controllability is to use the information contained in **A** to generate a supportable estimate of **B**.
This focus allows us to gain insight of the inherent controllability of a network, and the roles of the species that compose it, without being overly dependent on the particular choices of how the system dynamics are modelled or characterised. 
The trade-off of this approach is that, because of the assumption of linearity, structural controllability alone does not allow us to fully design the time-varying control signal *u(t)* that can drive the system from one particular equilibrium to another. 
Nevertheless, the lessons gained when assuming linearity---at both the network and the species level---are a prerequisite for eventually understanding nonlinear control [@liu_controllability_2011; @liu_control_2016]. 

# Maximum matching 

## Finding a single maximum matching {#one-maximum-matching}

Our approach to find the minumum number of driver nodes relies on finding maximum matchings. 
We start with a directed network in which the direction of the link represents the direction of control (Figure \@ref(fig:fig-maximum-matching-procedure) left panel). 
We then construct an alternative representation of the directed network in which each node of the directed network is represented by two nodes that indicate their outgoing and incoming links respectively (Figure \@ref(fig:fig-maximum-matching-procedure) center panel). 
Finding a maximum matching in this alternative representation is equivalent to finding the largest possible set of edges in which one node on the left-hand side is connected to at most one node on the right-hand side. 
To find the maximum matching we use the push-relabel algorithm implemented in `max_bipartite_matching` in the R package igraph 1.0.1 [@Csardi2006a]. 
Once we have the matching (shown in the Figure \@ref(fig:fig-maximum-matching-procedure) center panel) it is then easy to identify the roles of each node in this representation: nodes on the top-level that are connected to a matched (dark purple) link are superior while those connected to a matched link on the bottom-level are matched. 
This information can then be mapped back to the original representation to identify the control paths and the driver nodes in the network (Figure \@ref(fig:fig-maximum-matching-procedure) right panel). 

```{r}
drake::loadd(fig_supp_matching)
```

```{r fig-maximum-matching-procedure, fig.height=fig_supp_matching$height, fig.width=fig_supp_matching$width,fig.cap = "Finding a maximum matching in a complex network. (left) Directed network that indicate the direction of control between species. (center) Alternative bipartite representations of the directed networks. (right) The matchings in the bipartite representation mapped back to the original network."}
replayPlot(fig_supp_matching$plot)
```

## Finding all possible maximum matchings {#all-maximum-matching}

The algorithm implemented in `max_bipartite_matching`, however, is only able to find **one** of possibly many maximum matchings in a network. 
Though one maximum matching is enough to calculate *n~D~* and hence to provide indication of the manageability of a community, it is not sufficient to estimate the role of individual species. 
To do that, we need to calculate all possible maximum matchings (or, equivalently, all maximal cardinality matchings in weighted networks like ours). 
To do this, we again start from the alternative bipartite representation in Figure \@ref(fig:fig-maximum-matching-procedure)b and assign an identity to each of the links in the network.
We will call this bipartite representation *P*. 
We then construct the line graph of the alternative bipartite representation *L(P)* (Figure \@ref(fig:fig-all-maximum-matching)). 
Each node in *L(P)* represents a link in *P* and these are connected to each other if and only if they share a common node in *P*. 
We then calculate *H*, the complement graph of *L(P)* and identify all of its maximal cliques (Figure \@ref(fig:fig-all-maximum-matching)). 
Here some extra definitions are necessary. 
First, *H* is a graph with the same nodes as *L(P)* but that has a link between two nodes if and only if there is not a link in *L(P)*. 
Second, a clique is a subset of nodes such that all pairs of them are linked. 
Lastly, a maximal clique is a clique such that there are no cliques composed of more nodes [@Gutin2013]. 
In this example, there are two maximal cliques: the one formed by 1, 3 and 5, and the one formed by 2, 3 and 5. 
The final step is then to map these cliques onto the original network to obtain all possible maximal cardinality matchings as shown in Figure \@ref(M-fig:fig-control-configuration) in the main text.

```{r}
drake::loadd(fig_all_matching)
```

```{r fig-all-maximum-matching, fig.height=fig_all_matching$height, fig.width=fig_all_matching$width,fig.cap = "Finding all possible maximum matchings. From left to right: alternative bipartite representation of the directed network in Figure \\@ref(fig:fig-maximum-matching-procedure)a.  Line graph of the network. Complement of the network. The two maximal cliques are shown in dark purple."}
replayPlot(fig_all_matching$plot)
```

To further ilustrate our methodology here, we also show the approach for the smallest of our empirical networks, the uninvaded network at site 10 (Table \@ref(tab:table-network-properties); Figure \@ref(fig:fig-small-network)). 
This network is composed of 19 species of which three are non-invasive plants and the other 16 are pollinators. 
The one-to-one relationship between matched and superior nodes implies that in order to achieve full network controllability, most pollinators would be unmatched, and hence are classified as driver nodes that require external intervention. 
At the same time, both plants in the community, *Heracleum sphondylum* and *Rubus fructicosus*, and one of the pollinators, *Orthotylus/Lygocorus*, tend to be classified as superior nodes.

```{r}
drake::loadd(fig_small_network)
```

```{r fig-small-network, fig.height=fig_small_network$height, fig.width=fig_small_network$width,fig.cap = "Illustration of the procedure with an empirical community. The visitation network (top), the number of visits between species pairs is shown on each link. The directed network in which the direction of control is determined based on the mutual dependences (middle). One of the possible maximum matchings of this network (bottom)."}
replayPlot(fig_small_network$plot)
```

## Finding all possible minimum driver node sets

# Empirical vs. random expectation of controllability {#randomisations}

# References
